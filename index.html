<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SwingIQ">
    <title>SwingIQ</title>

    <!-- TensorFlow.js + MoveNet for pose detection -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@2.1.3/dist/pose-detection.min.js"></script>

    <!-- Chart.js for progress charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Marked.js for rendering Claude's markdown coaching text -->
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;600&display=swap');

        :root {
            --bg: #06080a;
            --surface: rgba(255,255,255,0.04);
            --surface-hover: rgba(255,255,255,0.08);
            --border: rgba(255,255,255,0.08);
            --green: #34d399;
            --green-dim: rgba(52,211,153,0.15);
            --yellow: #fbbf24;
            --yellow-dim: rgba(251,191,36,0.15);
            --red: #f87171;
            --red-dim: rgba(248,113,113,0.15);
            --text: #e5e7eb;
            --text-dim: #6b7280;
            --text-bright: #f9fafb;
            --mono: 'JetBrains Mono', monospace;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'DM Sans', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100dvh;
            overflow-x: hidden;
        }

        /* --- Utility --- */
        .glass { background: var(--surface); border: 1px solid var(--border); }
        .glass:hover { background: var(--surface-hover); }
        .mono { font-family: var(--mono); }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }
        .pulse { animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- Layout --- */
        .screen { min-height: 100dvh; display: flex; flex-direction: column; }
        .container { padding: 0 16px; max-width: 480px; margin: 0 auto; width: 100%; }
        .hidden { display: none !important; }

        /* --- Login --- */
        .login-screen {
            min-height: 100dvh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            background: radial-gradient(ellipse at 50% 0%, rgba(52,211,153,0.06) 0%, transparent 60%);
        }
        .login-card {
            width: 100%;
            max-width: 360px;
            text-align: center;
        }
        .login-logo {
            font-size: 48px;
            margin-bottom: 8px;
            filter: drop-shadow(0 0 20px rgba(52,211,153,0.3));
        }
        .login-title {
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: var(--text-bright);
        }
        .login-sub { color: var(--text-dim); font-size: 14px; margin-top: 4px; margin-bottom: 32px; }

        /* --- Inputs --- */
        input, select, textarea {
            font-family: 'DM Sans', sans-serif;
            background: rgba(0,0,0,0.4);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            color: var(--text-bright);
            font-size: 16px; /* prevents zoom on iOS */
            width: 100%;
            outline: none;
            transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--green); }
        input::placeholder, textarea::placeholder { color: var(--text-dim); }
        select { -webkit-appearance: none; appearance: none; cursor: pointer; }
        input[type="number"] { -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; }

        /* --- Buttons --- */
        .btn {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            width: 100%; padding: 14px 20px;
            border: none; border-radius: 14px;
            font-family: 'DM Sans', sans-serif;
            font-size: 16px; font-weight: 700;
            cursor: pointer; transition: all 0.2s;
        }
        .btn-primary { background: var(--green); color: #000; }
        .btn-primary:hover { background: #4ade9d; transform: translateY(-1px); }
        .btn-primary:disabled { background: #1f2937; color: #4b5563; cursor: not-allowed; transform: none; }
        .btn-ghost { background: transparent; color: var(--text-dim); border: 1px solid var(--border); }

        /* --- Header --- */
        .header {
            position: sticky; top: 0; z-index: 50;
            padding: 12px 16px;
            background: rgba(6,8,10,0.85);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
        }
        .header-inner { max-width: 480px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
        .logo { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 17px; color: var(--text-bright); }
        .tabs { display: flex; gap: 2px; }
        .tab {
            padding: 6px 14px; border-radius: 8px;
            font-size: 13px; font-weight: 500;
            color: var(--text-dim);
            cursor: pointer; transition: all 0.2s;
            border: none; background: none;
        }
        .tab.active { background: var(--green-dim); color: var(--green); }

        /* --- Cards --- */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
        }
        .card-label { font-size: 12px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }

        /* --- Score Ring --- */
        .score-ring { position: relative; width: 110px; height: 110px; flex-shrink: 0; }
        .score-ring svg { transform: rotate(-90deg); width: 100%; height: 100%; }
        .score-ring .ring-value {
            position: absolute; inset: 0;
            display: flex; align-items: center; justify-content: center; flex-direction: column;
        }
        .score-number { font-family: var(--mono); font-size: 32px; font-weight: 700; line-height: 1; }
        .score-label { font-size: 11px; color: var(--text-dim); margin-top: 2px; }

        /* --- Upload Area --- */
        .upload-zone {
            border: 2px dashed rgba(255,255,255,0.12);
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .upload-zone:hover, .upload-zone:active { border-color: var(--green); background: var(--green-dim); }
        .upload-icon { font-size: 36px; margin-bottom: 8px; }
        .upload-text { font-weight: 500; color: var(--text); font-size: 15px; }
        .upload-hint { font-size: 12px; color: var(--text-dim); margin-top: 4px; }

        /* --- Position Carousel --- */
        .position-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 4px; }
        .position-thumb {
            flex-shrink: 0; width: 100px;
            border-radius: 12px; overflow: hidden;
            border: 2px solid transparent;
            cursor: pointer; transition: border-color 0.2s;
        }
        .position-thumb.active, .position-thumb:hover { border-color: var(--green); }
        .position-thumb img { width: 100%; height: 130px; object-fit: cover; display: block; }
        .position-thumb-info { padding: 6px 8px; background: rgba(0,0,0,0.6); }
        .position-thumb-name { font-size: 11px; font-weight: 500; }
        .position-thumb-score { font-size: 11px; font-family: var(--mono); }

        /* --- Coaching Text --- */
        .coaching h2 { font-size: 16px; font-weight: 700; margin-top: 20px; margin-bottom: 8px; color: var(--green); }
        .coaching h3 { font-size: 14px; font-weight: 600; margin-top: 14px; color: var(--text-bright); }
        .coaching p { margin: 6px 0; line-height: 1.55; font-size: 14px; }
        .coaching strong { color: var(--text-bright); }
        .coaching ul, .coaching ol { padding-left: 18px; margin: 6px 0; }
        .coaching li { margin: 4px 0; font-size: 14px; line-height: 1.5; }

        /* --- Launch Data Grid --- */
        .lm-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .lm-field label { display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 4px; }
        .lm-field input { padding: 10px 12px; font-size: 14px; border-radius: 10px; }

        /* --- History Item --- */
        .history-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 16px;
            cursor: pointer;
        }
        .history-club { font-weight: 600; font-size: 15px; }
        .history-date { font-size: 12px; color: var(--text-dim); margin-top: 2px; }
        .history-score { font-family: var(--mono); font-size: 20px; font-weight: 700; }
        .history-hc { font-size: 12px; color: var(--text-dim); text-align: right; }

        /* --- Analyzing Overlay --- */
        .analyzing-overlay {
            position: fixed; inset: 0; z-index: 100;
            background: rgba(6,8,10,0.95);
            display: flex; align-items: center; justify-content: center;
            flex-direction: column; gap: 16px; padding: 40px;
            text-align: center;
        }
        .progress-bar { width: 100%; max-width: 280px; height: 4px; background: #1f2937; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--green); border-radius: 2px; transition: width 0.6s ease; }

        /* --- Detail View --- */
        .detail-angles { display: flex; flex-direction: column; gap: 2px; }
        .angle-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }
        .angle-name { font-size: 13px; display: flex; align-items: center; gap: 6px; }
        .angle-value { font-family: var(--mono); font-size: 13px; font-weight: 600; }
        .angle-range { font-size: 11px; color: var(--text-dim); margin-left: 6px; }

        /* --- Setup Screen --- */
        .setup-card { max-width: 400px; margin: 0 auto; padding: 32px 24px; }
        .setup-step { display: flex; gap: 12px; align-items: flex-start; margin-bottom: 20px; }
        .step-num {
            flex-shrink: 0; width: 28px; height: 28px;
            border-radius: 50%; background: var(--green-dim); color: var(--green);
            display: flex; align-items: center; justify-content: center;
            font-size: 13px; font-weight: 700;
        }
        .step-text { font-size: 14px; line-height: 1.5; }
        .step-text strong { color: var(--text-bright); }

        /* Canvas (hidden, used for processing) */
        .processing-canvas { display: none; }
    </style>
</head>
<body>

<!-- ===================== SETUP SCREEN ===================== -->
<div id="setupScreen" class="login-screen">
    <div class="login-card">
        <div class="login-logo">üèåÔ∏è</div>
        <div class="login-title">SwingIQ</div>
        <div class="login-sub">Personal Swing Analysis</div>

        <div id="setupStep1">
            <p style="font-size:14px; color:var(--text-dim); margin-bottom:16px;">
                Enter your Claude API key to get started.<br>
                <span style="font-size:12px;">Get one at <strong style="color:var(--green)">console.anthropic.com</strong></span>
            </p>
            <input id="apiKeyInput" type="password" placeholder="sk-ant-..." style="margin-bottom:12px; font-family:var(--mono); font-size:14px;">
            <input id="setupPassword" type="password" placeholder="Set an app password" style="margin-bottom:16px;">
            <button class="btn btn-primary" onclick="saveSetup()">Get Started</button>
            <p id="setupError" class="hidden" style="color:var(--red); font-size:13px; margin-top:12px;"></p>
        </div>

        <div id="loginStep" class="hidden">
            <input id="loginPassword" type="password" placeholder="Enter your password" style="margin-bottom:16px;"
                onkeydown="if(event.key==='Enter')doLogin()">
            <button class="btn btn-primary" onclick="doLogin()">Unlock</button>
            <p id="loginError" class="hidden" style="color:var(--red); font-size:13px; margin-top:12px;">Wrong password</p>
            <button class="btn btn-ghost" style="margin-top:12px; font-size:13px;" onclick="resetApp()">Reset App</button>
        </div>
    </div>
</div>

<!-- ===================== MAIN APP ===================== -->
<div id="mainApp" class="hidden screen">

    <!-- Header -->
    <div class="header">
        <div class="header-inner">
            <div class="logo">üèåÔ∏è SwingIQ</div>
            <div class="tabs">
                <button class="tab active" data-tab="analyze" onclick="switchTab('analyze')">Analyze</button>
                <button class="tab" data-tab="history" onclick="switchTab('history')">History</button>
                <button class="tab" data-tab="progress" onclick="switchTab('progress')">Progress</button>
            </div>
        </div>
    </div>

    <!-- ===================== ANALYZE TAB ===================== -->
    <div id="analyzeTab" class="container fade-in" style="padding-top:16px; padding-bottom:100px;">

        <!-- Club Selection -->
        <div class="card" style="margin-bottom:12px;">
            <div class="card-label">Club</div>
            <select id="clubSelect">
                <option>Driver</option>
                <option>3-Wood</option><option>5-Wood</option>
                <option>3-Hybrid</option><option>4-Hybrid</option>
                <option>4-Iron</option><option>5-Iron</option><option>6-Iron</option>
                <option>7-Iron</option><option>8-Iron</option><option>9-Iron</option>
                <option>Pitching Wedge</option><option>Gap Wedge</option>
                <option>Sand Wedge</option><option>Lob Wedge</option>
            </select>
        </div>

        <!-- Video Upload -->
        <div class="card" style="margin-bottom:12px;" id="uploadCard">
            <div class="card-label">Swing Video</div>
            <div class="upload-zone" id="uploadZone" onclick="document.getElementById('videoInput').click()">
                <div class="upload-icon">üì±</div>
                <div class="upload-text">Record or Choose Video</div>
                <div class="upload-hint">Tap to record or select from camera roll</div>
            </div>
            <input type="file" id="videoInput" accept="video/*" capture="environment" style="display:none" onchange="handleVideo(this)">

            <div id="videoPreview" class="hidden" style="margin-top:12px;">
                <video id="previewVid" style="width:100%; border-radius:12px;" controls playsinline></video>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:8px;">
                    <span id="vidName" style="font-size:12px; color:var(--text-dim); overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:200px;"></span>
                    <button onclick="clearVideo()" style="background:none; border:none; color:var(--red); font-size:13px; cursor:pointer;">Remove</button>
                </div>
            </div>
        </div>

        <!-- Launch Monitor Data -->
        <div class="card" style="margin-bottom:12px;">
            <div style="display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="toggleLM()">
                <div class="card-label" style="margin-bottom:0;">üìä Launch Monitor Data</div>
                <span id="lmToggleIcon" style="font-size:12px; color:var(--text-dim);">Ôºã Add</span>
            </div>
            <div id="lmSection" class="hidden" style="margin-top:16px;">
                <div class="lm-grid">
                    <div class="lm-field"><label>Ball Speed (mph)</label><input type="number" id="lmBallSpeed" step="0.1" placeholder="165"></div>
                    <div class="lm-field"><label>Club Speed (mph)</label><input type="number" id="lmClubSpeed" step="0.1" placeholder="112"></div>
                    <div class="lm-field"><label>Launch Angle (¬∞)</label><input type="number" id="lmLaunch" step="0.1" placeholder="12.5"></div>
                    <div class="lm-field"><label>Spin Rate (rpm)</label><input type="number" id="lmSpin" step="1" placeholder="2400"></div>
                    <div class="lm-field"><label>Carry (yards)</label><input type="number" id="lmCarry" step="0.1" placeholder="275"></div>
                    <div class="lm-field"><label>Smash Factor</label><input type="number" id="lmSmash" step="0.01" placeholder="1.47"></div>
                    <div class="lm-field"><label>Total Dist (yards)</label><input type="number" id="lmTotal" step="0.1" placeholder="295"></div>
                    <div class="lm-field"><label>Attack Angle (¬∞)</label><input type="number" id="lmAttack" step="0.1" placeholder="-1.5"></div>
                </div>
            </div>
        </div>

        <!-- Analyze Button -->
        <button class="btn btn-primary" id="analyzeBtn" onclick="runAnalysis()" disabled>
            üîç Analyze Swing ‚Äî Free
        </button>
        <div id="costTracker" style="text-align:center; margin-top:8px; font-size:12px; color:var(--text-dim);">
            Visual analysis is always free ¬∑ AI coaching: <span id="costDisplay">$0.00</span> spent (<span id="coachCount">0</span> coaching sessions)
        </div>

        <!-- ===== RESULTS ===== -->
        <div id="results" class="hidden fade-in" style="margin-top:20px;">

            <!-- Score Card -->
            <div class="card" style="display:flex; align-items:center; gap:20px; margin-bottom:12px;">
                <div class="score-ring">
                    <svg viewBox="0 0 36 36">
                        <path d="M18 2.0845a15.9155 15.9155 0 010 31.831 15.9155 15.9155 0 010-31.831"
                            fill="none" stroke="#1f2937" stroke-width="2.5"/>
                        <path id="scoreArc" d="M18 2.0845a15.9155 15.9155 0 010 31.831 15.9155 15.9155 0 010-31.831"
                            fill="none" stroke="var(--green)" stroke-width="2.5" stroke-dasharray="0, 100" stroke-linecap="round"/>
                    </svg>
                    <div class="ring-value">
                        <div class="score-number" id="rScore">--</div>
                        <div class="score-label">/ 100</div>
                    </div>
                </div>
                <div>
                    <div style="font-size:12px; color:var(--text-dim);">Estimated Handicap</div>
                    <div id="rHandicap" class="mono" style="font-size:28px; font-weight:700;">--</div>
                    <div id="rGrade" style="font-size:13px; color:var(--text-dim); margin-top:2px;">--</div>
                </div>
            </div>

            <!-- Position Carousel -->
            <div class="card" style="margin-bottom:12px;">
                <div class="card-label">Swing Positions</div>
                <div class="position-scroll no-scrollbar" id="posScroll"></div>
            </div>

            <!-- Position Detail -->
            <div id="posDetail" class="card hidden" style="margin-bottom:12px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                    <div id="detailName" style="font-weight:700; font-size:17px;"></div>
                    <div id="detailScore" class="mono" style="font-weight:700;"></div>
                </div>
                <canvas id="detailCanvas" style="width:100%; border-radius:12px; margin-bottom:12px;"></canvas>
                <div id="detailAngles" class="detail-angles"></div>
            </div>

            <!-- Coaching (Optional ‚Äî costs ~$0.30-0.60) -->
            <div class="card" style="margin-bottom:12px;">
                <div class="card-label">ü§ñ AI Coaching</div>
                <div id="coachingPlaceholder">
                    <p style="color:var(--text-dim); font-size:14px; margin-bottom:12px;">
                        Your visual analysis and score are above ‚Äî free, every swing.<br>
                        Want Claude's detailed coaching? Tap below.
                    </p>
                    <button class="btn btn-primary" id="getCoachingBtn" onclick="requestCoaching()" style="background:var(--green-dim); color:var(--green); border:1px solid rgba(52,211,153,0.3);">
                        ü§ñ Get AI Coaching (~$0.40)
                    </button>
                </div>
                <div id="coachingLoading" class="hidden" style="text-align:center; padding:20px;">
                    <div class="pulse" style="font-size:28px;">ü§ñ</div>
                    <p style="color:var(--text-dim); font-size:14px; margin-top:8px;">Getting coaching from Claude...</p>
                </div>
                <div id="coachingText" class="coaching hidden"></div>
            </div>

            <!-- Notes -->
            <div class="card">
                <div class="card-label">üìù Session Notes</div>
                <textarea id="sessionNotes" rows="3" placeholder="How did the session feel?"></textarea>
                <button class="btn btn-ghost" style="margin-top:10px; font-size:13px;" onclick="saveNotes()">Save Notes</button>
            </div>
        </div>
    </div>

    <!-- ===================== HISTORY TAB ===================== -->
    <div id="historyTab" class="container hidden fade-in" style="padding-top:16px; padding-bottom:40px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <h2 style="font-size:18px; font-weight:700;">History</h2>
            <select id="histFilter" onchange="renderHistory()" style="width:auto; padding:6px 12px; font-size:13px; border-radius:8px;">
                <option value="">All Clubs</option>
                <option>Driver</option><option>7-Iron</option>
            </select>
        </div>
        <div id="histList"></div>
    </div>

    <!-- ===================== PROGRESS TAB ===================== -->
    <div id="progressTab" class="container hidden fade-in" style="padding-top:16px; padding-bottom:40px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <h2 style="font-size:18px; font-weight:700;">Progress</h2>
            <select id="progFilter" onchange="renderProgress()" style="width:auto; padding:6px 12px; font-size:13px; border-radius:8px;">
                <option value="">All Clubs</option>
                <option>Driver</option><option>7-Iron</option>
            </select>
        </div>
        <div class="card" style="margin-bottom:12px;">
            <div class="card-label">Swing Score</div>
            <canvas id="progScoreChart" height="180"></canvas>
        </div>
        <div class="card" style="margin-bottom:12px;">
            <div class="card-label">Estimated Handicap</div>
            <canvas id="progHcChart" height="180"></canvas>
        </div>
        <div class="card">
            <div class="card-label">Launch Monitor Trends</div>
            <canvas id="progLmChart" height="220"></canvas>
        </div>
    </div>
</div>

<!-- Analyzing Overlay -->
<div id="analyzingOverlay" class="analyzing-overlay hidden">
    <div class="pulse" style="font-size:56px;">üèåÔ∏è</div>
    <div style="font-weight:700; font-size:18px; color:var(--text-bright);">Analyzing your swing</div>
    <div id="analysisStep" style="font-size:14px; color:var(--text-dim);">Preparing...</div>
    <div class="progress-bar"><div id="progressFill" class="progress-fill" style="width:0%"></div></div>
</div>

<!-- Hidden canvases for processing -->
<canvas id="frameCanvas" class="processing-canvas"></canvas>
<canvas id="annotCanvas" class="processing-canvas"></canvas>

<script>
// ========================================================================
//  SWINGIQ ‚Äî Client-Side Golf Swing Analysis
//  Runs entirely in the browser. No server needed.
// ========================================================================

// --- Constants ---
const POSITIONS = ['Address', 'Takeaway', 'Top', 'Downswing', 'Impact', 'Follow-Through'];
const STORAGE_KEY = 'swingiq_data';

// MoveNet keypoint indices
const KP = {
    NOSE: 0, L_EYE: 1, R_EYE: 2, L_EAR: 3, R_EAR: 4,
    L_SHOULDER: 5, R_SHOULDER: 6, L_ELBOW: 7, R_ELBOW: 8,
    L_WRIST: 9, R_WRIST: 10, L_HIP: 11, R_HIP: 12,
    L_KNEE: 13, R_KNEE: 14, L_ANKLE: 15, R_ANKLE: 16,
};

// Optimal angle ranges per position
const OPTIMAL = {
    Address:       { spine_angle: [28,38], knee_flex_lead: [140,160] },
    Takeaway:      { spine_angle: [28,38], left_arm_angle: [160,180] },
    Top:           { spine_angle: [25,40], left_arm_angle: [155,180] },
    Downswing:     { spine_angle: [28,42] },
    Impact:        { spine_angle: [28,42], left_arm_angle: [155,180] },
    'Follow-Through': { spine_angle: [15,35] },
};

// Position weights for overall score
const POS_WEIGHTS = { Address:1, Takeaway:0.8, Top:1.2, Downswing:1.3, Impact:1.5, 'Follow-Through':0.7 };

// --- State ---
let appState = loadState();
let videoFile = null;
let detector = null;
let currentResults = null;
let currentSessionId = null;

// ======================== STORAGE ========================
function loadState() {
    try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return { apiKey: '', password: '', sessions: [], totalApiCost: 0, coachingCount: 0 };
        const state = JSON.parse(raw);
        if (state.totalApiCost == null) state.totalApiCost = 0;
        if (state.coachingCount == null) state.coachingCount = 0;
        return state;
    } catch { return { apiKey: '', password: '', sessions: [], totalApiCost: 0, coachingCount: 0 }; }
}

function saveState() {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(appState)); } catch(e) { console.error('Save failed:', e); }
}

// ======================== SETUP / LOGIN ========================
function initApp() {
    if (appState.apiKey && appState.password) {
        document.getElementById('setupStep1').classList.add('hidden');
        document.getElementById('loginStep').classList.remove('hidden');
    }
    if (appState.loggedIn) {
        showMainApp();
    }
}

function saveSetup() {
    const key = document.getElementById('apiKeyInput').value.trim();
    const pw = document.getElementById('setupPassword').value;
    if (!key.startsWith('sk-ant-')) {
        showError('setupError', 'API key should start with sk-ant-');
        return;
    }
    if (pw.length < 4) {
        showError('setupError', 'Password must be at least 4 characters');
        return;
    }
    appState.apiKey = key;
    appState.password = pw;
    appState.loggedIn = true;
    saveState();
    showMainApp();
}

function doLogin() {
    const pw = document.getElementById('loginPassword').value;
    if (pw === appState.password) {
        appState.loggedIn = true;
        saveState();
        showMainApp();
    } else {
        document.getElementById('loginError').classList.remove('hidden');
    }
}

function resetApp() {
    if (confirm('This will erase ALL data including your sessions and API key. Are you sure?')) {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
    }
}

function showMainApp() {
    document.getElementById('setupScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    updateCostDisplay();
    initPoseDetector();
}

function updateCostDisplay() {
    const costEl = document.getElementById('costDisplay');
    const countEl = document.getElementById('coachCount');
    if (costEl) costEl.textContent = '$' + (appState.totalApiCost || 0).toFixed(2);
    if (countEl) countEl.textContent = appState.coachingCount || 0;
}

function showError(id, msg) {
    const el = document.getElementById(id);
    el.textContent = msg;
    el.classList.remove('hidden');
}

// ======================== TABS ========================
function switchTab(tab) {
    ['analyze', 'history', 'progress'].forEach(t => {
        document.getElementById(t + 'Tab').classList.toggle('hidden', t !== tab);
        document.querySelector(`.tab[data-tab="${t}"]`).classList.toggle('active', t === tab);
    });
    if (tab === 'history') renderHistory();
    if (tab === 'progress') renderProgress();
}

// ======================== VIDEO HANDLING ========================
function handleVideo(input) {
    const file = input.files[0];
    if (!file) return;
    videoFile = file;
    document.getElementById('uploadZone').classList.add('hidden');
    document.getElementById('videoPreview').classList.remove('hidden');
    document.getElementById('vidName').textContent = file.name;
    const vid = document.getElementById('previewVid');
    vid.src = URL.createObjectURL(file);
    document.getElementById('analyzeBtn').disabled = false;
}

function clearVideo() {
    videoFile = null;
    document.getElementById('uploadZone').classList.remove('hidden');
    document.getElementById('videoPreview').classList.add('hidden');
    document.getElementById('videoInput').value = '';
    document.getElementById('analyzeBtn').disabled = true;
}

function toggleLM() {
    const s = document.getElementById('lmSection');
    const icon = document.getElementById('lmToggleIcon');
    s.classList.toggle('hidden');
    icon.textContent = s.classList.contains('hidden') ? 'Ôºã Add' : 'Ôºç Hide';
}

// ======================== POSE DETECTOR INIT ========================
async function initPoseDetector() {
    try {
        const model = poseDetection.SupportedModels.MoveNet;
        detector = await poseDetection.createDetector(model, {
            modelType: poseDetection.movenet.modelType.SINGLEPOSE_THUNDER,
        });
        console.log('Pose detector ready');
    } catch(e) {
        console.error('Failed to init pose detector:', e);
    }
}

// ======================== MAIN ANALYSIS PIPELINE ========================
async function runAnalysis() {
    if (!videoFile || !detector) {
        if (!detector) { alert('Pose detector still loading. Wait a moment and try again.'); return; }
        return;
    }

    const overlay = document.getElementById('analyzingOverlay');
    overlay.classList.remove('hidden');
    updateProgress('Loading video...', 5);

    try {
        // Step 1: Extract frames from video
        updateProgress('Extracting key positions...', 10);
        const frames = await extractFrames(videoFile);

        // Step 2: Run pose detection on each frame
        const positionResults = [];
        for (let i = 0; i < frames.length; i++) {
            updateProgress(`Analyzing ${POSITIONS[i]}...`, 15 + (i * 12));
            const result = await analyzePosition(frames[i], POSITIONS[i]);
            positionResults.push(result);
        }

        // Step 3: Compute swing score
        updateProgress('Computing swing score...', 85);
        const swingScore = computeSwingScore(positionResults);

        // Step 4: Get launch monitor data
        const launchData = getLaunchData();

        // Step 5: Save session (NO Claude call ‚Äî that's optional)
        updateProgress('Saving session...', 95);

        const session = {
            id: Date.now(),
            date: new Date().toISOString(),
            club: document.getElementById('clubSelect').value,
            swingScore,
            positions: positionResults.map(r => ({
                position: r.position,
                angles: r.angles,
                scores: r.scores,
                imageData: r.annotatedDataUrl,
            })),
            coaching: null, // Filled in later if user requests it
            launchData,
            notes: '',
        };

        appState.sessions.unshift(session);
        if (appState.sessions.length > 200) appState.sessions = appState.sessions.slice(0, 200);
        saveState();

        currentResults = session;
        currentSessionId = session.id;

        // Step 6: Display results (instant, free!)
        updateProgress('Done!', 100);
        setTimeout(() => {
            overlay.classList.add('hidden');
            displayResults(session);
        }, 400);

    } catch(e) {
        overlay.classList.add('hidden');
        alert('Analysis error: ' + e.message);
        console.error(e);
    }
}

function updateProgress(step, pct) {
    document.getElementById('analysisStep').textContent = step;
    document.getElementById('progressFill').style.width = pct + '%';
}

// ======================== FRAME EXTRACTION ========================
async function extractFrames(file) {
    return new Promise((resolve, reject) => {
        const video = document.createElement('video');
        video.muted = true;
        video.playsInline = true;
        video.preload = 'auto';

        video.onloadedmetadata = async () => {
            const duration = video.duration;
            if (duration < 0.5) { reject(new Error('Video too short')); return; }

            const canvas = document.getElementById('frameCanvas');
            const ctx = canvas.getContext('2d');

            // Sample frames throughout the video to find the swing
            const sampleCount = Math.min(60, Math.floor(duration * 15));
            const motionProfile = [];
            const sampleFrames = [];

            for (let i = 0; i < sampleCount; i++) {
                const t = (i / sampleCount) * duration;
                try {
                    const imgData = await seekAndCapture(video, canvas, ctx, t);
                    sampleFrames.push({ time: t, imageData: imgData });

                    if (i > 0) {
                        const prev = sampleFrames[i - 1].imageData;
                        const curr = imgData;
                        const motion = computeMotion(prev, curr, canvas.width, canvas.height);
                        motionProfile.push({ time: t, motion });
                    } else {
                        motionProfile.push({ time: t, motion: 0 });
                    }
                } catch { motionProfile.push({ time: t, motion: 0 }); }
            }

            // Find swing window from motion profile
            const keyTimes = findKeyPositionTimes(motionProfile, duration);

            // Extract frames at key times
            const frames = [];
            for (const t of keyTimes) {
                try {
                    const imgData = await seekAndCapture(video, canvas, ctx, t);
                    frames.push({ time: t, imageData: imgData, width: canvas.width, height: canvas.height });
                } catch(e) {
                    console.warn('Frame extraction failed at', t);
                }
            }

            URL.revokeObjectURL(video.src);
            if (frames.length < 4) reject(new Error('Could not extract enough frames. Try a clearer video.'));
            else resolve(frames);
        };

        video.onerror = () => reject(new Error('Could not load video'));
        video.src = URL.createObjectURL(file);
    });
}

function seekAndCapture(video, canvas, ctx, time) {
    return new Promise((resolve, reject) => {
        video.currentTime = time;
        video.onseeked = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            resolve(imageData);
        };
        video.onerror = reject;
        setTimeout(() => reject(new Error('Seek timeout')), 5000);
    });
}

function computeMotion(prev, curr, w, h) {
    let diff = 0;
    const step = 8; // Sample every 8th pixel for speed
    for (let i = 0; i < prev.data.length; i += step * 4) {
        const dr = Math.abs(prev.data[i] - curr.data[i]);
        const dg = Math.abs(prev.data[i+1] - curr.data[i+1]);
        const db = Math.abs(prev.data[i+2] - curr.data[i+2]);
        diff += (dr + dg + db) / 3;
    }
    return diff / (prev.data.length / (step * 4));
}

function findKeyPositionTimes(motionProfile, duration) {
    if (motionProfile.length < 6) {
        // Fallback: evenly space
        return Array.from({length: 6}, (_, i) => (i / 5) * duration * 0.9);
    }

    const motions = motionProfile.map(m => m.motion);
    const times = motionProfile.map(m => m.time);

    // Smooth
    const smoothed = smoothArray(motions, 3);

    // Find peak (impact)
    let peakIdx = 0;
    for (let i = 1; i < smoothed.length; i++) {
        if (smoothed[i] > smoothed[peakIdx]) peakIdx = i;
    }

    // Find top of backswing (local min before peak)
    let topIdx = Math.floor(peakIdx * 0.5);
    let minVal = Infinity;
    const searchStart = Math.floor(peakIdx * 0.25);
    const searchEnd = Math.max(searchStart + 1, peakIdx - 1);
    for (let i = searchStart; i < searchEnd; i++) {
        if (smoothed[i] < minVal) { minVal = smoothed[i]; topIdx = i; }
    }

    // Threshold for swing start
    const peakVal = smoothed[peakIdx];
    const threshold = peakVal * 0.15;
    let swingStartIdx = 0;
    for (let i = 0; i < topIdx; i++) {
        if (smoothed[i] > threshold) { swingStartIdx = Math.max(0, i - 2); break; }
    }

    // Address: just before swing starts
    const addressIdx = Math.max(0, swingStartIdx - 2);

    // Takeaway: between address and top
    const takeawayIdx = addressIdx + Math.round((topIdx - addressIdx) * 0.4);

    // Downswing: between top and impact
    const downswingIdx = topIdx + Math.round((peakIdx - topIdx) * 0.5);

    // Follow-through: after impact
    const remaining = smoothed.length - 1 - peakIdx;
    const followIdx = Math.min(smoothed.length - 1, peakIdx + Math.round(remaining * 0.5));

    const indices = [addressIdx, takeawayIdx, topIdx, downswingIdx, peakIdx, followIdx];

    // Ensure strictly increasing
    for (let i = 1; i < indices.length; i++) {
        if (indices[i] <= indices[i-1]) indices[i] = Math.min(indices[i-1] + 1, smoothed.length - 1);
    }

    return indices.map(i => times[Math.min(i, times.length - 1)]);
}

function smoothArray(arr, radius) {
    const result = [];
    for (let i = 0; i < arr.length; i++) {
        let sum = 0, count = 0;
        for (let j = Math.max(0, i - radius); j <= Math.min(arr.length - 1, i + radius); j++) {
            sum += arr[j]; count++;
        }
        result.push(sum / count);
    }
    return result;
}

// ======================== POSE ANALYSIS ========================
async function analyzePosition(frame, positionName) {
    const canvas = document.getElementById('frameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = frame.width;
    canvas.height = frame.height;
    ctx.putImageData(frame.imageData, 0, 0);

    // Run pose detection
    let keypoints = null;
    try {
        const poses = await detector.estimatePoses(canvas);
        if (poses.length > 0) keypoints = poses[0].keypoints;
    } catch(e) { console.warn('Pose detection failed for', positionName); }

    // Calculate angles
    const angles = keypoints ? calculateAngles(keypoints, frame.width, frame.height) : {};

    // Score angles
    const scores = scoreAngles(angles, positionName);

    // Draw annotations
    const annotCanvas = document.getElementById('annotCanvas');
    annotCanvas.width = frame.width;
    annotCanvas.height = frame.height;
    const actx = annotCanvas.getContext('2d');
    actx.putImageData(frame.imageData, 0, 0);

    if (keypoints) drawAnnotations(actx, keypoints, angles, scores, positionName, frame.width, frame.height);

    // Position label + score header
    const posScore = computePositionScore(scores);
    drawHeader(actx, positionName, posScore, frame.width);

    return {
        position: positionName,
        angles,
        scores,
        positionScore: posScore,
        annotatedDataUrl: annotCanvas.toDataURL('image/jpeg', 0.85),
        poseDetected: !!keypoints,
    };
}

function kp(keypoints, idx) {
    const k = keypoints[idx];
    return { x: k.x, y: k.y, score: k.score || 0 };
}

function angleBetween(a, b, c) {
    const ba = { x: a.x - b.x, y: a.y - b.y };
    const bc = { x: c.x - b.x, y: c.y - b.y };
    const dot = ba.x * bc.x + ba.y * bc.y;
    const magBA = Math.sqrt(ba.x * ba.x + ba.y * ba.y);
    const magBC = Math.sqrt(bc.x * bc.x + bc.y * bc.y);
    if (magBA * magBC === 0) return 0;
    let cosAngle = dot / (magBA * magBC);
    cosAngle = Math.max(-1, Math.min(1, cosAngle));
    return Math.acos(cosAngle) * (180 / Math.PI);
}

function angleFromVertical(a, b) {
    const dx = Math.abs(b.x - a.x);
    const dy = Math.abs(b.y - a.y);
    return Math.atan2(dx, dy) * (180 / Math.PI);
}

function calculateAngles(keypoints, w, h) {
    const ls = kp(keypoints, KP.L_SHOULDER);
    const rs = kp(keypoints, KP.R_SHOULDER);
    const lh = kp(keypoints, KP.L_HIP);
    const rh = kp(keypoints, KP.R_HIP);
    const lk = kp(keypoints, KP.L_KNEE);
    const rk = kp(keypoints, KP.R_KNEE);
    const la = kp(keypoints, KP.L_ANKLE);
    const ra = kp(keypoints, KP.R_ANKLE);
    const le = kp(keypoints, KP.L_ELBOW);
    const re = kp(keypoints, KP.R_ELBOW);
    const lw = kp(keypoints, KP.L_WRIST);
    const rw = kp(keypoints, KP.R_WRIST);
    const nose = kp(keypoints, KP.NOSE);

    const midHip = { x: (lh.x + rh.x) / 2, y: (lh.y + rh.y) / 2 };
    const midShoulder = { x: (ls.x + rs.x) / 2, y: (ls.y + rs.y) / 2 };

    const angles = {};
    angles.spine_angle = round(angleFromVertical(midHip, midShoulder));
    angles.knee_flex_lead = round(angleBetween(lh, lk, la));
    angles.knee_flex_trail = round(angleBetween(rh, rk, ra));
    angles.left_arm_angle = round(angleBetween(ls, le, lw));
    angles.right_arm_angle = round(angleBetween(rs, re, rw));

    const sw = Math.abs(ls.x - rs.x);
    const hw = Math.abs(lh.x - rh.x);
    if (hw > 0) angles.hip_rotation = round(Math.max(0, (1 - hw / Math.max(sw, 1)) * 90));

    angles.shoulder_tilt = round(Math.abs(Math.atan2(rs.y - ls.y, rs.x - ls.x) * (180 / Math.PI)));

    angles.head_x = round(nose.x / w * 100);
    angles.head_y = round(nose.y / h * 100);
    angles.hip_center_x = round(midHip.x / w * 100);

    return angles;
}

function round(v) { return Math.round(v * 10) / 10; }

function scoreAngles(angles, position) {
    const optimal = OPTIMAL[position] || {};
    const scores = {};
    for (const [name, [lo, hi]] of Object.entries(optimal)) {
        const val = angles[name];
        if (val == null) continue;
        let deviation = 0;
        if (val < lo) deviation = lo - val;
        else if (val > hi) deviation = val - hi;
        const score = Math.max(0, Math.round(100 - deviation * 5));
        const status = deviation === 0 ? 'good' : deviation <= 5 ? 'warning' : 'critical';
        scores[name] = { score, status, value: val, range: [lo, hi], deviation: round(deviation) };
    }
    return scores;
}

function computePositionScore(scores) {
    const vals = Object.values(scores);
    if (vals.length === 0) return 75;
    return Math.round(vals.reduce((s, v) => s + v.score, 0) / vals.length);
}

// ======================== ANNOTATION DRAWING ========================
function drawAnnotations(ctx, keypoints, angles, scores, position, w, h) {
    const ls = kp(keypoints, KP.L_SHOULDER), rs = kp(keypoints, KP.R_SHOULDER);
    const lh = kp(keypoints, KP.L_HIP), rh = kp(keypoints, KP.R_HIP);
    const lk = kp(keypoints, KP.L_KNEE), rk = kp(keypoints, KP.R_KNEE);
    const la = kp(keypoints, KP.L_ANKLE), ra = kp(keypoints, KP.R_ANKLE);
    const le = kp(keypoints, KP.L_ELBOW), re = kp(keypoints, KP.R_ELBOW);
    const lw = kp(keypoints, KP.L_WRIST), rw = kp(keypoints, KP.R_WRIST);
    const nose = kp(keypoints, KP.NOSE);

    const midHip = { x: (lh.x + rh.x) / 2, y: (lh.y + rh.y) / 2 };
    const midShoulder = { x: (ls.x + rs.x) / 2, y: (ls.y + rs.y) / 2 };

    ctx.lineWidth = Math.max(2, w / 300);
    const dotR = Math.max(4, w / 150);

    // Skeleton
    const skeletonPairs = [
        [ls, rs], [lh, rh], [ls, lh], [rs, rh],
        [ls, le], [le, lw], [rs, re], [re, rw],
        [lh, lk], [lk, la], [rh, rk], [rk, ra],
        [ls, nose], [rs, nose],
    ];
    ctx.strokeStyle = 'rgba(200,200,200,0.4)';
    ctx.lineWidth = Math.max(1.5, w / 400);
    for (const [a, b] of skeletonPairs) {
        ctx.beginPath(); ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y); ctx.stroke();
    }

    // Joint dots
    const joints = [ls, rs, lh, rh, lk, rk, la, ra, le, re, lw, rw, nose];
    for (const j of joints) {
        ctx.fillStyle = '#fff';
        ctx.beginPath(); ctx.arc(j.x, j.y, dotR, 0, Math.PI * 2); ctx.fill();
        ctx.strokeStyle = 'rgba(52,211,153,0.8)';
        ctx.lineWidth = 1.5;
        ctx.stroke();
    }

    // Spine line
    const spineStatus = scores.spine_angle?.status || 'good';
    const spineColor = statusColor(spineStatus);
    ctx.strokeStyle = spineColor;
    ctx.lineWidth = Math.max(3, w / 200);
    const dx = midShoulder.x - midHip.x, dy = midShoulder.y - midHip.y;
    ctx.beginPath();
    ctx.moveTo(midHip.x - dx * 0.25, midHip.y - dy * 0.25);
    ctx.lineTo(midShoulder.x + dx * 0.3, midShoulder.y + dy * 0.3);
    ctx.stroke();

    // Vertical reference
    ctx.strokeStyle = 'rgba(100,100,100,0.4)';
    ctx.lineWidth = 1;
    ctx.setLineDash([4, 4]);
    ctx.beginPath();
    ctx.moveTo(midHip.x, midHip.y);
    ctx.lineTo(midHip.x, midHip.y - Math.abs(dy) * 1.3);
    ctx.stroke();
    ctx.setLineDash([]);

    // Spine angle label
    if (angles.spine_angle != null) {
        drawLabel(ctx, `Spine: ${angles.spine_angle}¬∞`, midHip.x + 15, midHip.y - 25, spineColor, w);
    }

    // Arm lines
    const armStatus = scores.left_arm_angle?.status || 'good';
    ctx.strokeStyle = statusColor(armStatus);
    ctx.lineWidth = Math.max(2.5, w / 250);
    ctx.beginPath(); ctx.moveTo(ls.x, ls.y); ctx.lineTo(le.x, le.y); ctx.lineTo(lw.x, lw.y); ctx.stroke();
    if (angles.left_arm_angle != null) {
        drawLabel(ctx, `L Arm: ${angles.left_arm_angle}¬∞`, le.x - 70, le.y - 10, statusColor(armStatus), w);
    }

    // Knee label
    if (angles.knee_flex_lead != null) {
        const kneeStatus = scores.knee_flex_lead?.status || 'good';
        drawLabel(ctx, `Knee: ${angles.knee_flex_lead}¬∞`, lk.x - 60, lk.y + 15, statusColor(kneeStatus), w);
    }
}

function drawHeader(ctx, position, score, w) {
    const h = Math.max(36, w / 12);
    ctx.fillStyle = 'rgba(0,0,0,0.7)';
    ctx.fillRect(0, 0, w, h);

    ctx.font = `bold ${h * 0.5}px 'DM Sans', sans-serif`;
    ctx.fillStyle = '#fff';
    ctx.fillText(position, 10, h * 0.68);

    const color = score >= 75 ? '#34d399' : score >= 50 ? '#fbbf24' : '#f87171';
    const scoreText = `${score}/100`;
    const tm = ctx.measureText(scoreText);
    ctx.fillStyle = color;
    ctx.fillText(scoreText, w - tm.width - 10, h * 0.68);
}

function drawLabel(ctx, text, x, y, color, frameW) {
    const fontSize = Math.max(11, frameW / 50);
    ctx.font = `500 ${fontSize}px 'DM Sans', sans-serif`;
    const tm = ctx.measureText(text);
    const px = 4, py = 3;

    // Clamp to frame
    x = Math.max(5, Math.min(x, frameW - tm.width - px * 2 - 5));

    ctx.fillStyle = 'rgba(0,0,0,0.75)';
    ctx.fillRect(x - px, y - fontSize - py, tm.width + px * 2, fontSize + py * 2 + 2);
    ctx.fillStyle = color;
    ctx.fillText(text, x, y);
}

function statusColor(status) {
    if (status === 'good') return '#34d399';
    if (status === 'warning') return '#fbbf24';
    return '#f87171';
}

// ======================== SWING SCORE ========================
function computeSwingScore(positionResults) {
    let weightedSum = 0, weightTotal = 0;
    const posScores = {};

    for (const r of positionResults) {
        const ps = r.positionScore;
        posScores[r.position] = ps;
        const w = POS_WEIGHTS[r.position] || 1;
        weightedSum += ps * w;
        weightTotal += w;
    }

    const score = weightTotal > 0 ? Math.round(weightedSum / weightTotal) : 0;

    let handicap;
    if (score >= 90) handicap = Math.max(-2, (100 - score) * 0.5 - 2);
    else if (score >= 80) handicap = (90 - score) * 0.5;
    else if (score >= 70) handicap = 5 + (80 - score) * 0.5;
    else if (score >= 60) handicap = 10 + (70 - score) * 0.5;
    else if (score >= 50) handicap = 15 + (60 - score) * 0.5;
    else if (score >= 40) handicap = 20 + (50 - score) * 0.5;
    else handicap = 25 + (40 - score) * 0.5;

    let grade;
    if (score >= 90) grade = 'Tour-caliber mechanics';
    else if (score >= 80) grade = 'Very strong fundamentals';
    else if (score >= 70) grade = 'Solid mechanics, minor issues';
    else if (score >= 60) grade = 'Good foundation, areas to improve';
    else if (score >= 50) grade = 'Developing swing, key fixes needed';
    else if (score >= 40) grade = 'Fundamentals need work';
    else grade = 'Significant rebuilding needed';

    return { score, handicap: Math.round(handicap * 10) / 10, grade, positionScores: posScores };
}

// ======================== CLAUDE API ========================
async function getClaudeCoaching(positionResults, swingScore, launchData) {
    const club = document.getElementById('clubSelect').value;

    // Build content with images
    const content = [];

    let overview = `## Swing Analysis Request\n\n**Club:** ${club}\n**Swing Score:** ${swingScore.score}/100\n**Estimated Handicap:** ${swingScore.handicap}\n**Grade:** ${swingScore.grade}\n\n### Position Scores:\n`;
    for (const [pos, sc] of Object.entries(swingScore.positionScores)) overview += `- ${pos}: ${sc}/100\n`;
    content.push({ type: 'text', text: overview });

    for (const r of positionResults) {
        content.push({ type: 'text', text: `\n### ${r.position} Position:` });

        // Add annotated image
        const base64 = r.annotatedDataUrl.split(',')[1];
        content.push({ type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: base64 } });

        let angleText = `**Measured Angles (${r.position}):**\n`;
        for (const [k, v] of Object.entries(r.angles)) angleText += `- ${k}: ${v}¬∞\n`;
        if (Object.keys(r.scores).length > 0) {
            angleText += `\n**Scoring:**\n`;
            for (const [k, s] of Object.entries(r.scores)) {
                const icon = s.status === 'good' ? '‚úÖ' : s.status === 'warning' ? '‚ö†Ô∏è' : 'üî¥';
                angleText += `- ${icon} ${k}: ${s.value}¬∞ (optimal: ${s.range[0]}-${s.range[1]}¬∞, deviation: ${s.deviation}¬∞)\n`;
            }
        }
        content.push({ type: 'text', text: angleText });
    }

    if (launchData && Object.keys(launchData).length > 0) {
        let lmText = '\n### Launch Monitor Data:\n';
        const labels = { ball_speed:'Ball Speed (mph)', club_speed:'Club Speed (mph)', launch_angle:'Launch Angle (¬∞)',
            spin_rate:'Spin Rate (rpm)', carry:'Carry (yards)', smash_factor:'Smash Factor',
            total_distance:'Total Distance (yards)', attack_angle:'Attack Angle (¬∞)' };
        for (const [k, label] of Object.entries(labels)) {
            if (launchData[k] != null) lmText += `- **${label}:** ${launchData[k]}\n`;
        }
        content.push({ type: 'text', text: lmText });
    }

    content.push({ type: 'text', text: '\nProvide your complete analysis following the format in your instructions. Be specific about angles and fixes.' });

    const systemPrompt = `You are SwingIQ ‚Äî an expert golf coach analyzing a player's swing using pose detection data and annotated swing images. Provide specific, actionable, severity-ranked feedback.

Format your response in these sections:
## üèåÔ∏è PRO GOLFER MATCH
Name one tour pro this swing most resembles and explain why.

## üìä POSITION-BY-POSITION ANALYSIS
For each position: what's working (with angles), what needs work, and one specific fix.

## ‚ö†Ô∏è SEVERITY-RANKED ISSUES
All issues ranked by severity (1-10):
- **Severity: X/10** ‚Äî Issue name
- What/Cause ‚Üí Effect/Fix/Pro reference

## üéØ TOP 3 PRIORITIES
Three most impactful changes with specific drills.

## üìà TRACKMAN INSIGHTS
(Only if launch data provided) What numbers reveal about mechanics.

## üèÜ SWING SCORE CONTEXT
What the score means and how to improve 5-10 points.`;

    const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'x-api-key': appState.apiKey,
            'anthropic-version': '2023-06-01',
            'anthropic-dangerous-direct-browser-access': 'true',
        },
        body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 4000,
            system: systemPrompt,
            messages: [{ role: 'user', content }],
        }),
    });

    if (!response.ok) {
        const err = await response.json().catch(() => ({}));
        throw new Error(err.error?.message || `API error ${response.status}`);
    }

    const data = await response.json();

    // Track approximate cost (Sonnet: ~$3/M input, ~$15/M output tokens)
    const usage = data.usage || {};
    const inputCost = (usage.input_tokens || 0) / 1000000 * 3;
    const outputCost = (usage.output_tokens || 0) / 1000000 * 15;
    const callCost = Math.round((inputCost + outputCost) * 100) / 100;
    appState.totalApiCost = Math.round((appState.totalApiCost + callCost) * 100) / 100;
    appState.coachingCount++;
    saveState();

    return data.content.map(b => b.text || '').join('\n');
}

// ======================== LAUNCH MONITOR DATA ========================
function getLaunchData() {
    const fields = {
        ball_speed: 'lmBallSpeed', club_speed: 'lmClubSpeed',
        launch_angle: 'lmLaunch', spin_rate: 'lmSpin',
        carry: 'lmCarry', smash_factor: 'lmSmash',
        total_distance: 'lmTotal', attack_angle: 'lmAttack',
    };
    const data = {};
    for (const [key, id] of Object.entries(fields)) {
        const val = document.getElementById(id).value;
        if (val) data[key] = parseFloat(val);
    }
    return Object.keys(data).length > 0 ? data : null;
}

// ======================== DISPLAY RESULTS ========================
function displayResults(session) {
    document.getElementById('results').classList.remove('hidden');

    // Score ring
    const s = session.swingScore;
    const color = s.score >= 75 ? 'var(--green)' : s.score >= 50 ? 'var(--yellow)' : 'var(--red)';
    document.getElementById('scoreArc').setAttribute('stroke', color);
    document.getElementById('scoreArc').setAttribute('stroke-dasharray', `${s.score}, 100`);
    document.getElementById('rScore').textContent = s.score;
    document.getElementById('rScore').style.color = color;
    document.getElementById('rHandicap').textContent = s.handicap;
    document.getElementById('rGrade').textContent = s.grade;

    // Position carousel
    const scroll = document.getElementById('posScroll');
    scroll.innerHTML = '';
    session.positions.forEach((pos, i) => {
        const div = document.createElement('div');
        div.className = 'position-thumb' + (i === 0 ? ' active' : '');
        const sc = pos.scores ? computePositionScore(pos.scores) : 75;
        const scColor = sc >= 75 ? 'var(--green)' : sc >= 50 ? 'var(--yellow)' : 'var(--red)';
        div.innerHTML = `
            <img src="${pos.imageData}" alt="${pos.position}">
            <div class="position-thumb-info">
                <div class="position-thumb-name">${pos.position}</div>
                <div class="position-thumb-score" style="color:${scColor}">${sc}</div>
            </div>`;
        div.onclick = () => {
            scroll.querySelectorAll('.position-thumb').forEach(t => t.classList.remove('active'));
            div.classList.add('active');
            showPositionDetail(pos);
        };
        scroll.appendChild(div);
    });

    // Show first position detail
    if (session.positions.length > 0) showPositionDetail(session.positions[0]);

    // Coaching ‚Äî show placeholder or existing coaching
    const coachPlaceholder = document.getElementById('coachingPlaceholder');
    const coachLoading = document.getElementById('coachingLoading');
    const coachDiv = document.getElementById('coachingText');
    
    if (session.coaching) {
        coachPlaceholder.classList.add('hidden');
        coachLoading.classList.add('hidden');
        coachDiv.classList.remove('hidden');
        try { coachDiv.innerHTML = marked.parse(session.coaching); }
        catch { coachDiv.innerHTML = session.coaching.replace(/\n/g, '<br>'); }
    } else {
        coachPlaceholder.classList.remove('hidden');
        coachLoading.classList.add('hidden');
        coachDiv.classList.add('hidden');
    }

    // Scroll to results
    document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
}

function showPositionDetail(pos) {
    document.getElementById('posDetail').classList.remove('hidden');
    document.getElementById('detailName').textContent = pos.position;

    const sc = pos.scores ? computePositionScore(pos.scores) : 75;
    const scEl = document.getElementById('detailScore');
    scEl.textContent = sc + '/100';
    scEl.style.color = sc >= 75 ? 'var(--green)' : sc >= 50 ? 'var(--yellow)' : 'var(--red)';

    // Draw image to detail canvas
    const canvas = document.getElementById('detailCanvas');
    const img = new Image();
    img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        canvas.style.height = 'auto';
        canvas.getContext('2d').drawImage(img, 0, 0);
    };
    img.src = pos.imageData;

    // Angle details
    const anglesDiv = document.getElementById('detailAngles');
    anglesDiv.innerHTML = '';

    if (pos.scores) {
        for (const [name, s] of Object.entries(pos.scores)) {
            const icon = s.status === 'good' ? '‚úÖ' : s.status === 'warning' ? '‚ö†Ô∏è' : 'üî¥';
            anglesDiv.innerHTML += `<div class="angle-row">
                <div class="angle-name">${icon} ${formatName(name)}</div>
                <div><span class="angle-value" style="color:${statusColor(s.status)}">${s.value}¬∞</span>
                <span class="angle-range">(${s.range[0]}-${s.range[1]}¬∞)</span></div>
            </div>`;
        }
    }

    if (pos.angles) {
        for (const [name, val] of Object.entries(pos.angles)) {
            if (!pos.scores || !pos.scores[name]) {
                if (name.startsWith('head_') || name.startsWith('hip_center')) continue;
                anglesDiv.innerHTML += `<div class="angle-row">
                    <div class="angle-name" style="color:var(--text-dim)">${formatName(name)}</div>
                    <div class="angle-value">${val}¬∞</div>
                </div>`;
            }
        }
    }
}

function formatName(n) { return n.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()); }

// ======================== REQUEST COACHING (OPTIONAL, PAID) ========================
async function requestCoaching() {
    if (!currentResults) return;

    const placeholder = document.getElementById('coachingPlaceholder');
    const loading = document.getElementById('coachingLoading');
    const coachDiv = document.getElementById('coachingText');

    placeholder.classList.add('hidden');
    loading.classList.remove('hidden');

    try {
        // Rebuild position results from saved session data for Claude
        const positionResults = currentResults.positions.map(p => ({
            position: p.position,
            angles: p.angles,
            scores: p.scores,
            annotatedDataUrl: p.imageData,
            poseDetected: true,
        }));

        const coachingText = await getClaudeCoaching(
            positionResults,
            currentResults.swingScore,
            currentResults.launchData,
        );

        // Save coaching to session
        currentResults.coaching = coachingText;
        const session = appState.sessions.find(s => s.id === currentSessionId);
        if (session) { session.coaching = coachingText; saveState(); }

        // Display
        loading.classList.add('hidden');
        coachDiv.classList.remove('hidden');
        try { coachDiv.innerHTML = marked.parse(coachingText); }
        catch { coachDiv.innerHTML = coachingText.replace(/\n/g, '<br>'); }

        coachDiv.scrollIntoView({ behavior: 'smooth' });
        updateCostDisplay();

    } catch(e) {
        loading.classList.add('hidden');
        placeholder.classList.remove('hidden');
        alert('Coaching error: ' + e.message + '\n\nMake sure your API key is valid and you have credits.');
    }
}

// ======================== SAVE NOTES ========================
function saveNotes() {
    if (!currentSessionId) return;
    const notes = document.getElementById('sessionNotes').value;
    const session = appState.sessions.find(s => s.id === currentSessionId);
    if (session) { session.notes = notes; saveState(); }
    alert('Notes saved!');
}

// ======================== HISTORY ========================
function renderHistory() {
    const filter = document.getElementById('histFilter').value;
    let sessions = appState.sessions;
    if (filter) sessions = sessions.filter(s => s.club === filter);

    const list = document.getElementById('histList');
    if (sessions.length === 0) {
        list.innerHTML = '<p style="text-align:center; color:var(--text-dim); padding:40px 0;">No sessions yet. Analyze your first swing!</p>';
        return;
    }

    list.innerHTML = sessions.map(s => {
        const date = new Date(s.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        const sc = s.swingScore?.score ?? '--';
        const hc = s.swingScore?.handicap ?? '--';
        const color = sc >= 75 ? 'var(--green)' : sc >= 50 ? 'var(--yellow)' : 'var(--red)';
        const coachBadge = s.coaching ? '<span style="font-size:10px; background:var(--green-dim); color:var(--green); padding:2px 6px; border-radius:4px; margin-left:6px;">ü§ñ Coached</span>' : '';
        return `<div class="card history-item" style="margin-bottom:8px;" onclick="viewHistorySession(${s.id})">
            <div><div class="history-club">${s.club}${coachBadge}</div><div class="history-date">${date}</div></div>
            <div style="text-align:right"><div class="history-score" style="color:${color}">${sc}</div><div class="history-hc">HC: ${hc}</div></div>
        </div>`;
    }).join('');
}

function viewHistorySession(id) {
    const session = appState.sessions.find(s => s.id === id);
    if (!session) return;
    currentResults = session;
    currentSessionId = id;
    switchTab('analyze');
    displayResults(session);
}

// ======================== PROGRESS CHARTS ========================
let chartScore, chartHc, chartLm;

function renderProgress() {
    const filter = document.getElementById('progFilter').value;
    let sessions = [...appState.sessions].reverse();
    if (filter) sessions = sessions.filter(s => s.club === filter);

    if (sessions.length === 0) return;

    const labels = sessions.map(s => {
        const d = new Date(s.date);
        return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    });

    const chartOpts = {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
            x: { ticks: { color: '#6b7280', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.05)' } },
            y: { ticks: { color: '#6b7280' }, grid: { color: 'rgba(255,255,255,0.05)' } },
        },
    };

    // Score
    if (chartScore) chartScore.destroy();
    chartScore = new Chart(document.getElementById('progScoreChart'), {
        type: 'line',
        data: { labels, datasets: [{ data: sessions.map(s => s.swingScore?.score), borderColor: '#34d399', backgroundColor: 'rgba(52,211,153,0.08)', fill: true, tension: 0.3, pointRadius: 4 }] },
        options: { ...chartOpts, scales: { ...chartOpts.scales, y: { ...chartOpts.scales.y, min: 0, max: 100 } } },
    });

    // Handicap
    if (chartHc) chartHc.destroy();
    chartHc = new Chart(document.getElementById('progHcChart'), {
        type: 'line',
        data: { labels, datasets: [{ data: sessions.map(s => s.swingScore?.handicap), borderColor: '#fbbf24', backgroundColor: 'rgba(251,191,36,0.08)', fill: true, tension: 0.3, pointRadius: 4 }] },
        options: chartOpts,
    });

    // Launch monitor
    if (chartLm) chartLm.destroy();
    const colors = { ball_speed: '#f87171', club_speed: '#60a5fa', carry: '#34d399', smash_factor: '#a78bfa' };
    const dLabels = { ball_speed: 'Ball Speed', club_speed: 'Club Speed', carry: 'Carry', smash_factor: 'Smash√ó100' };
    const datasets = [];
    for (const [key, color] of Object.entries(colors)) {
        const vals = sessions.map(s => {
            const v = s.launchData?.[key];
            return v != null ? (key === 'smash_factor' ? v * 100 : v) : null;
        });
        if (vals.some(v => v != null)) datasets.push({ label: dLabels[key], data: vals, borderColor: color, tension: 0.3, pointRadius: 3, spanGaps: true });
    }
    chartLm = new Chart(document.getElementById('progLmChart'), {
        type: 'line',
        data: { labels, datasets },
        options: { ...chartOpts, plugins: { legend: { display: true, labels: { color: '#6b7280', font: { size: 10 } } } } },
    });
}

// ======================== INIT ========================
initApp();
</script>
</body>
</html>
