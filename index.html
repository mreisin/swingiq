<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SwingIQ">
    <title>SwingIQ</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@2.1.3/dist/pose-detection.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@400;600&display=swap');
        :root{--bg:#06080a;--surface:rgba(255,255,255,0.04);--surface-hover:rgba(255,255,255,0.08);--border:rgba(255,255,255,0.08);--green:#34d399;--green-dim:rgba(52,211,153,0.15);--yellow:#fbbf24;--yellow-dim:rgba(251,191,36,0.15);--red:#f87171;--red-dim:rgba(248,113,113,0.15);--text:#e5e7eb;--text-dim:#6b7280;--text-bright:#f9fafb;--mono:'JetBrains Mono',monospace}
        *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
        body{font-family:'DM Sans',-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100dvh;overflow-x:hidden}
        .glass{background:var(--surface);border:1px solid var(--border)}.hidden{display:none!important}
        .fade-in{animation:fadeIn .4s ease-out}@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
        .pulse{animation:pulse 2s ease-in-out infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
        .no-scrollbar::-webkit-scrollbar{display:none}.no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
        input,select,textarea{font-family:'DM Sans',sans-serif;background:rgba(0,0,0,.4);border:1px solid var(--border);border-radius:12px;padding:12px 16px;color:var(--text-bright);font-size:16px;width:100%;outline:none;transition:border-color .2s}
        input:focus,select:focus,textarea:focus{border-color:var(--green)}input::placeholder,textarea::placeholder{color:var(--text-dim)}
        select{-webkit-appearance:none;appearance:none;cursor:pointer}input[type="number"]{-moz-appearance:textfield}input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none}
        .btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:14px 20px;border:none;border-radius:14px;font-family:'DM Sans',sans-serif;font-size:16px;font-weight:700;cursor:pointer;transition:all .2s}
        .btn-primary{background:var(--green);color:#000}.btn-primary:hover{background:#4ade9d}.btn-primary:disabled{background:#1f2937;color:#4b5563;cursor:not-allowed}
        .btn-ghost{background:transparent;color:var(--text-dim);border:1px solid var(--border)}
        .btn-danger{background:var(--red-dim);color:var(--red);border:1px solid rgba(248,113,113,0.2)}
        .btn-sm{padding:8px 16px;font-size:13px;width:auto;border-radius:10px}
        .header{position:sticky;top:0;z-index:50;padding:12px 16px;background:rgba(6,8,10,.85);backdrop-filter:blur(20px);border-bottom:1px solid var(--border)}
        .header-inner{max-width:480px;margin:0 auto;display:flex;align-items:center;justify-content:space-between}
        .logo{display:flex;align-items:center;gap:8px;font-weight:700;font-size:17px;color:var(--text-bright)}
        .tabs{display:flex;gap:2px}.tab{padding:6px 14px;border-radius:8px;font-size:13px;font-weight:500;color:var(--text-dim);cursor:pointer;border:none;background:none}
        .tab.active{background:var(--green-dim);color:var(--green)}
        .container{padding:0 16px;max-width:480px;margin:0 auto;width:100%}
        .card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:12px}
        .card-label{font-size:12px;color:var(--text-dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px}
        .score-ring{position:relative;width:110px;height:110px;flex-shrink:0}
        .score-ring svg{transform:rotate(-90deg);width:100%;height:100%}
        .ring-value{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column}
        .score-number{font-family:var(--mono);font-size:32px;font-weight:700;line-height:1}
        .score-label{font-size:11px;color:var(--text-dim);margin-top:2px}
        .upload-zone{border:2px dashed rgba(255,255,255,.12);border-radius:16px;padding:40px 20px;text-align:center;cursor:pointer;transition:all .2s}
        .upload-zone:hover,.upload-zone:active{border-color:var(--green);background:var(--green-dim)}
        .position-scroll{display:flex;gap:10px;overflow-x:auto;padding-bottom:4px}
        .position-thumb{flex-shrink:0;width:100px;border-radius:12px;overflow:hidden;border:2px solid transparent;cursor:pointer;transition:border-color .2s}
        .position-thumb.active,.position-thumb:hover{border-color:var(--green)}
        .position-thumb img{width:100%;height:130px;object-fit:cover;display:block}
        .position-thumb-info{padding:6px 8px;background:rgba(0,0,0,.6)}
        .position-thumb-name{font-size:11px;font-weight:500}.position-thumb-score{font-size:11px;font-family:var(--mono)}
        .coaching h2{font-size:16px;font-weight:700;margin-top:20px;margin-bottom:8px;color:var(--green)}
        .coaching h3{font-size:14px;font-weight:600;margin-top:14px;color:var(--text-bright)}
        .coaching p{margin:6px 0;line-height:1.55;font-size:14px}.coaching strong{color:var(--text-bright)}
        .coaching ul,.coaching ol{padding-left:18px;margin:6px 0}.coaching li{margin:4px 0;font-size:14px;line-height:1.5}
        .lm-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .lm-field label{display:block;font-size:11px;color:var(--text-dim);margin-bottom:4px}
        .lm-field input{padding:10px 12px;font-size:14px;border-radius:10px}
        .angle-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border)}
        .angle-name{font-size:13px;display:flex;align-items:center;gap:6px}
        .angle-value{font-family:var(--mono);font-size:13px;font-weight:600}
        .angle-range{font-size:11px;color:var(--text-dim);margin-left:6px}
        .analyzing-overlay{position:fixed;inset:0;z-index:100;background:rgba(6,8,10,.95);display:flex;align-items:center;justify-content:center;flex-direction:column;gap:16px;padding:40px;text-align:center}
        .progress-bar{width:100%;max-width:280px;height:4px;background:#1f2937;border-radius:2px;overflow:hidden}
        .progress-fill{height:100%;background:var(--green);border-radius:2px;transition:width .6s ease}
        .swing-card{display:flex;align-items:center;gap:12px;padding:14px;border-radius:14px;background:var(--surface);border:1px solid var(--border);margin-bottom:8px}
        .swing-card img{width:70px;height:90px;object-fit:cover;border-radius:8px;flex-shrink:0}
        .swing-card-info{flex:1;min-width:0}
        .swing-card-actions{display:flex;gap:6px;flex-shrink:0}
        .voice-indicator{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:600}
        .voice-on{background:var(--green-dim);color:var(--green)}.voice-off{background:var(--surface);color:var(--text-dim)}
        .processing-canvas{display:none}
        .history-item{display:flex;align-items:center;justify-content:space-between;padding:16px;cursor:pointer}
        .mono{font-family:var(--mono)}
    </style>
</head>
<body>

<!-- SETUP SCREEN -->
<div id="setupScreen" class="fade-in" style="min-height:100dvh;display:flex;align-items:center;justify-content:center;padding:24px;background:radial-gradient(ellipse at 50% 0%,rgba(52,211,153,.06) 0%,transparent 60%)">
    <div style="width:100%;max-width:360px;text-align:center">
        <div style="font-size:48px;margin-bottom:8px;filter:drop-shadow(0 0 20px rgba(52,211,153,.3))">üèåÔ∏è</div>
        <div style="font-size:28px;font-weight:700;letter-spacing:-.5px;color:var(--text-bright)">SwingIQ</div>
        <div style="color:var(--text-dim);font-size:14px;margin-top:4px;margin-bottom:32px">Personal Swing Analysis</div>
        <div id="setupStep1">
            <p style="font-size:14px;color:var(--text-dim);margin-bottom:16px">Enter your Claude API key to get started.<br><span style="font-size:12px">Get one at <strong style="color:var(--green)">console.anthropic.com</strong></span></p>
            <input id="apiKeyInput" type="password" placeholder="sk-ant-..." style="margin-bottom:12px;font-family:var(--mono);font-size:14px">
            <input id="setupPassword" type="password" placeholder="Set an app password" style="margin-bottom:16px">
            <button class="btn btn-primary" onclick="saveSetup()">Get Started</button>
            <p id="setupError" class="hidden" style="color:var(--red);font-size:13px;margin-top:12px"></p>
        </div>
        <div id="loginStep" class="hidden">
            <input id="loginPassword" type="password" placeholder="Enter your password" style="margin-bottom:16px" onkeydown="if(event.key==='Enter')doLogin()">
            <button class="btn btn-primary" onclick="doLogin()">Unlock</button>
            <p id="loginError" class="hidden" style="color:var(--red);font-size:13px;margin-top:12px">Wrong password</p>
            <button class="btn btn-ghost" style="margin-top:12px;font-size:13px" onclick="resetApp()">Reset App</button>
        </div>
    </div>
</div>

<!-- MAIN APP -->
<div id="mainApp" class="hidden" style="min-height:100dvh;display:flex;flex-direction:column">
    <div class="header">
        <div class="header-inner">
            <div class="logo">üèåÔ∏è SwingIQ</div>
            <div class="tabs">
                <button class="tab active" data-tab="analyze" onclick="switchTab('analyze')">Analyze</button>
                <button class="tab" data-tab="history" onclick="switchTab('history')">History</button>
                <button class="tab" data-tab="progress" onclick="switchTab('progress')">Progress</button>
            </div>
        </div>
    </div>

    <!-- ANALYZE TAB -->
    <div id="analyzeTab" class="container fade-in" style="padding-top:16px;padding-bottom:100px">

        <!-- Mode Toggle -->
        <div class="card" style="display:flex;gap:8px">
            <button id="modeUpload" class="btn btn-sm" style="flex:1;background:var(--green-dim);color:var(--green)" onclick="setMode('upload')">üìÅ Upload Video</button>
            <button id="modeLive" class="btn btn-sm" style="flex:1" onclick="setMode('live')">üéôÔ∏è Live Practice</button>
        </div>

        <!-- UPLOAD MODE -->
        <div id="uploadMode">
            <div class="card">
                <div class="card-label">Club</div>
                <select id="clubSelect">
                    <option>Driver</option><option>3-Wood</option><option>5-Wood</option>
                    <option>3-Hybrid</option><option>4-Hybrid</option>
                    <option>4-Iron</option><option>5-Iron</option><option>6-Iron</option>
                    <option>7-Iron</option><option>8-Iron</option><option>9-Iron</option>
                    <option>Pitching Wedge</option><option>Gap Wedge</option>
                    <option>Sand Wedge</option><option>Lob Wedge</option>
                </select>
            </div>

            <div class="card" id="uploadCard">
                <div class="card-label">Swing Video</div>
                <div class="upload-zone" id="uploadZone" onclick="document.getElementById('videoInput').click()">
                    <div style="font-size:36px;margin-bottom:8px">üì±</div>
                    <div style="font-weight:500;font-size:15px">Record or Choose Video</div>
                    <div style="font-size:12px;color:var(--text-dim);margin-top:4px">Supports multi-swing videos ‚Äî we'll detect each swing</div>
                </div>
                <input type="file" id="videoInput" accept="video/*" style="display:none" onchange="handleVideo(this)">
                <div id="videoPreview" class="hidden" style="margin-top:12px">
                    <video id="previewVid" style="width:100%;border-radius:12px" controls playsinline></video>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
                        <span id="vidName" style="font-size:12px;color:var(--text-dim);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:200px"></span>
                        <button onclick="clearVideo()" style="background:none;border:none;color:var(--red);font-size:13px;cursor:pointer">Remove</button>
                    </div>
                </div>
            </div>

            <!-- Launch Monitor -->
            <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center;cursor:pointer" onclick="toggleLM()">
                    <div class="card-label" style="margin-bottom:0">üìä Launch Monitor Data</div>
                    <span id="lmToggleIcon" style="font-size:12px;color:var(--text-dim)">Ôºã Add</span>
                </div>
                <div id="lmSection" class="hidden" style="margin-top:16px">
                    <div class="lm-grid">
                        <div class="lm-field"><label>Ball Speed (mph)</label><input type="number" id="lmBallSpeed" step="0.1" placeholder="165"></div>
                        <div class="lm-field"><label>Club Speed (mph)</label><input type="number" id="lmClubSpeed" step="0.1" placeholder="112"></div>
                        <div class="lm-field"><label>Launch Angle (¬∞)</label><input type="number" id="lmLaunch" step="0.1" placeholder="12.5"></div>
                        <div class="lm-field"><label>Spin Rate (rpm)</label><input type="number" id="lmSpin" step="1" placeholder="2400"></div>
                        <div class="lm-field"><label>Carry (yards)</label><input type="number" id="lmCarry" step="0.1" placeholder="275"></div>
                        <div class="lm-field"><label>Smash Factor</label><input type="number" id="lmSmash" step="0.01" placeholder="1.47"></div>
                        <div class="lm-field"><label>Total Dist (yards)</label><input type="number" id="lmTotal" step="0.1" placeholder="295"></div>
                        <div class="lm-field"><label>Attack Angle (¬∞)</label><input type="number" id="lmAttack" step="0.1" placeholder="-1.5"></div>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" id="analyzeBtn" onclick="runAnalysis()" disabled>üîç Analyze Swing(s)</button>
        </div>

        <!-- LIVE PRACTICE MODE -->
        <div id="liveMode" class="hidden">
            <div class="card" style="text-align:center">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <div class="card-label" style="margin-bottom:0">Live Practice</div>
                    <div class="voice-indicator voice-on" id="voiceToggle" onclick="toggleVoice()" style="cursor:pointer">
                        üîä Voice On
                    </div>
                </div>
                <video id="liveVideo" style="width:100%;border-radius:12px;background:#111" autoplay playsinline muted></video>
                <div style="margin-top:12px;display:flex;gap:8px">
                    <select id="liveClubSelect" style="flex:1">
                        <option>Driver</option><option>3-Wood</option><option>5-Wood</option>
                        <option>7-Iron</option><option>8-Iron</option><option>9-Iron</option>
                        <option>Pitching Wedge</option><option>Sand Wedge</option>
                    </select>
                    <button class="btn btn-primary btn-sm" id="liveStartBtn" onclick="toggleLivePractice()" style="white-space:nowrap">‚ñ∂ Start</button>
                </div>
                <div id="liveStatus" style="margin-top:12px;font-size:13px;color:var(--text-dim)">Press Start, then swing. Voice feedback after each swing.</div>
                <div id="liveSwingCount" class="hidden" style="margin-top:8px;font-size:24px;font-weight:700;color:var(--green);font-family:var(--mono)">0 swings</div>
            </div>

            <!-- Live swing results appear here -->
            <div id="liveResults" style="margin-top:12px"></div>
        </div>

        <!-- MULTI-SWING RESULTS (after upload analysis) -->
        <div id="multiSwingResults" class="hidden fade-in" style="margin-top:16px">
            <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <div class="card-label" style="margin-bottom:0">Detected Swings</div>
                    <span id="swingCountLabel" class="mono" style="font-size:13px;color:var(--green)">0 swings</span>
                </div>
                <div id="swingList"></div>
                <div style="display:flex;gap:8px;margin-top:12px">
                    <button class="btn btn-primary btn-sm" style="flex:1" onclick="saveAllSwings()">‚úì Save All</button>
                    <button class="btn btn-ghost btn-sm" style="flex:1" onclick="discardAllSwings()">‚úï Discard All</button>
                </div>
            </div>

            <!-- Batch Coaching -->
            <div id="batchCoachSection" class="hidden">
                <button class="btn btn-primary" onclick="runBatchCoaching()" id="batchCoachBtn">ü§ñ Get AI Coaching for Saved Swings</button>
                <div id="batchCoachResult" class="hidden card" style="margin-top:12px">
                    <div class="card-label">ü§ñ Session Coaching</div>
                    <div id="batchCoachText" class="coaching"></div>
                </div>
            </div>
        </div>

        <!-- SINGLE SWING DETAIL (when a swing is tapped) -->
        <div id="swingDetail" class="hidden fade-in" style="margin-top:12px">
            <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <button class="btn btn-ghost btn-sm" onclick="hideSwingDetail()">‚Üê Back</button>
                    <span id="detailSwingLabel" class="mono" style="font-size:14px;font-weight:700"></span>
                </div>
                <div style="display:flex;align-items:center;gap:20px;margin-bottom:16px">
                    <div class="score-ring">
                        <svg viewBox="0 0 36 36">
                            <path d="M18 2.0845a15.9155 15.9155 0 010 31.831 15.9155 15.9155 0 010-31.831" fill="none" stroke="#1f2937" stroke-width="2.5"/>
                            <path id="detailScoreArc" d="M18 2.0845a15.9155 15.9155 0 010 31.831 15.9155 15.9155 0 010-31.831" fill="none" stroke="var(--green)" stroke-width="2.5" stroke-dasharray="0,100" stroke-linecap="round"/>
                        </svg>
                        <div class="ring-value">
                            <div class="score-number" id="detailScore">--</div>
                            <div class="score-label">/ 100</div>
                        </div>
                    </div>
                    <div>
                        <div style="font-size:12px;color:var(--text-dim)">Estimated Handicap</div>
                        <div id="detailHc" class="mono" style="font-size:28px;font-weight:700">--</div>
                        <div id="detailGrade" style="font-size:13px;color:var(--text-dim);margin-top:2px">--</div>
                    </div>
                </div>

                <div class="card-label">Positions</div>
                <div class="position-scroll no-scrollbar" id="detailPosScroll"></div>
            </div>

            <div id="detailPosDetail" class="card hidden">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                    <div id="detailPosName" style="font-weight:700;font-size:17px"></div>
                    <div id="detailPosScore" class="mono" style="font-weight:700"></div>
                </div>
                <canvas id="detailCanvas" style="width:100%;border-radius:12px;margin-bottom:12px"></canvas>
                <div id="detailAngles" style="display:flex;flex-direction:column;gap:2px"></div>
            </div>
        </div>
    </div>

    <!-- HISTORY TAB -->
    <div id="historyTab" class="container hidden fade-in" style="padding-top:16px;padding-bottom:40px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h2 style="font-size:18px;font-weight:700">History</h2>
            <select id="histFilter" onchange="renderHistory()" style="width:auto;padding:6px 12px;font-size:13px;border-radius:8px">
                <option value="">All Clubs</option><option>Driver</option><option>7-Iron</option>
            </select>
        </div>
        <div id="histList"></div>
    </div>

    <!-- PROGRESS TAB -->
    <div id="progressTab" class="container hidden fade-in" style="padding-top:16px;padding-bottom:40px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h2 style="font-size:18px;font-weight:700">Progress</h2>
            <select id="progFilter" onchange="renderProgress()" style="width:auto;padding:6px 12px;font-size:13px;border-radius:8px">
                <option value="">All Clubs</option><option>Driver</option><option>7-Iron</option>
            </select>
        </div>
        <div class="card"><div class="card-label">Swing Score</div><canvas id="progScoreChart" height="180"></canvas></div>
        <div class="card"><div class="card-label">Estimated Handicap</div><canvas id="progHcChart" height="180"></canvas></div>
        <div class="card"><div class="card-label">Launch Monitor Trends</div><canvas id="progLmChart" height="220"></canvas></div>
    </div>
</div>

<!-- Analyzing Overlay -->
<div id="analyzingOverlay" class="analyzing-overlay hidden">
    <div class="pulse" style="font-size:56px">üèåÔ∏è</div>
    <div style="font-weight:700;font-size:18px;color:var(--text-bright)">Analyzing your swing(s)</div>
    <div id="analysisStep" style="font-size:14px;color:var(--text-dim)">Preparing...</div>
    <div class="progress-bar"><div id="progressFill" class="progress-fill" style="width:0%"></div></div>
</div>

<!-- Hidden canvases -->
<canvas id="frameCanvas" class="processing-canvas"></canvas>
<canvas id="annotCanvas" class="processing-canvas"></canvas>
<canvas id="liveCanvas" class="processing-canvas"></canvas>

<script>
// ========================================================================
//  SWINGIQ v2 ‚Äî Multi-swing, Save/Discard, Batch Coaching, Voice
// ========================================================================
const POSITIONS=['Address','Takeaway','Top','Downswing','Impact','Follow-Through'];
const STORAGE_KEY='swingiq_data';
const KP={NOSE:0,L_EYE:1,R_EYE:2,L_EAR:3,R_EAR:4,L_SHOULDER:5,R_SHOULDER:6,L_ELBOW:7,R_ELBOW:8,L_WRIST:9,R_WRIST:10,L_HIP:11,R_HIP:12,L_KNEE:13,R_KNEE:14,L_ANKLE:15,R_ANKLE:16};
const OPTIMAL={Address:{spine_angle:[28,38],knee_flex_lead:[140,160]},Takeaway:{spine_angle:[28,38],left_arm_angle:[160,180]},Top:{spine_angle:[25,40],left_arm_angle:[155,180]},Downswing:{spine_angle:[28,42]},Impact:{spine_angle:[28,42],left_arm_angle:[155,180]},'Follow-Through':{spine_angle:[15,35]}};
const POS_WEIGHTS={Address:1,Takeaway:.8,Top:1.2,Downswing:1.3,Impact:1.5,'Follow-Through':.7};

let appState=loadState();
let videoFile=null;
let detector=null;
let detectedSwings=[];  // Array of swing objects after multi-swing detection
let voiceEnabled=true;
let livePracticeActive=false;
let liveStream=null;
let liveSwingCount=0;
let liveAnalysisInterval=null;
let prevMotion=null;
let motionBaseline=0;
let swingCooldown=false;

// ======================== STORAGE ========================
function loadState(){try{const r=localStorage.getItem(STORAGE_KEY);return r?JSON.parse(r):{apiKey:'',password:'',sessions:[]}}catch{return{apiKey:'',password:'',sessions:[]}}}
function saveState(){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(appState))}catch(e){console.error('Save failed:',e)}}

// ======================== SETUP / LOGIN ========================
function initApp(){if(appState.apiKey&&appState.password){document.getElementById('setupStep1').classList.add('hidden');document.getElementById('loginStep').classList.remove('hidden')}if(appState.loggedIn)showMainApp()}
function saveSetup(){const key=document.getElementById('apiKeyInput').value.trim();const pw=document.getElementById('setupPassword').value;if(!key.startsWith('sk-ant-')){showError('setupError','API key should start with sk-ant-');return}if(pw.length<4){showError('setupError','Password must be at least 4 characters');return}appState.apiKey=key;appState.password=pw;appState.loggedIn=true;saveState();showMainApp()}
function doLogin(){const pw=document.getElementById('loginPassword').value;if(pw===appState.password){appState.loggedIn=true;saveState();showMainApp()}else document.getElementById('loginError').classList.remove('hidden')}
function resetApp(){if(confirm('This will erase ALL data including sessions and API key. Sure?')){localStorage.removeItem(STORAGE_KEY);location.reload()}}
function showMainApp(){document.getElementById('setupScreen').classList.add('hidden');document.getElementById('mainApp').classList.remove('hidden');initPoseDetector()}
function showError(id,msg){const el=document.getElementById(id);el.textContent=msg;el.classList.remove('hidden')}

// ======================== TABS ========================
function switchTab(tab){['analyze','history','progress'].forEach(t=>{document.getElementById(t+'Tab').classList.toggle('hidden',t!==tab);document.querySelector(`.tab[data-tab="${t}"]`).classList.toggle('active',t===tab)});if(tab==='history')renderHistory();if(tab==='progress')renderProgress()}

// ======================== MODE TOGGLE ========================
function setMode(mode){
    document.getElementById('uploadMode').classList.toggle('hidden',mode!=='upload');
    document.getElementById('liveMode').classList.toggle('hidden',mode!=='live');
    document.getElementById('modeUpload').style.background=mode==='upload'?'var(--green-dim)':'transparent';
    document.getElementById('modeUpload').style.color=mode==='upload'?'var(--green)':'var(--text-dim)';
    document.getElementById('modeLive').style.background=mode==='live'?'var(--green-dim)':'transparent';
    document.getElementById('modeLive').style.color=mode==='live'?'var(--green)':'var(--text-dim)';
    if(mode==='live')initLiveCamera();
    else stopLivePractice();
}

// ======================== VIDEO HANDLING ========================
function handleVideo(input){const file=input.files[0];if(!file)return;videoFile=file;document.getElementById('uploadZone').classList.add('hidden');document.getElementById('videoPreview').classList.remove('hidden');document.getElementById('vidName').textContent=file.name;document.getElementById('previewVid').src=URL.createObjectURL(file);document.getElementById('analyzeBtn').disabled=false}
function clearVideo(){videoFile=null;document.getElementById('uploadZone').classList.remove('hidden');document.getElementById('videoPreview').classList.add('hidden');document.getElementById('videoInput').value='';document.getElementById('analyzeBtn').disabled=true}
function toggleLM(){const s=document.getElementById('lmSection');const i=document.getElementById('lmToggleIcon');s.classList.toggle('hidden');i.textContent=s.classList.contains('hidden')?'Ôºã Add':'Ôºç Hide'}

// ======================== VOICE ========================
function speak(text){if(!voiceEnabled)return;try{const u=new SpeechSynthesisUtterance(text);u.rate=1.1;u.pitch=1;u.lang='en-US';speechSynthesis.speak(u)}catch(e){console.warn('Speech failed:',e)}}
function toggleVoice(){voiceEnabled=!voiceEnabled;const el=document.getElementById('voiceToggle');el.className='voice-indicator '+(voiceEnabled?'voice-on':'voice-off');el.innerHTML=voiceEnabled?'üîä Voice On':'üîá Voice Off'}

// ======================== POSE DETECTOR ========================
async function initPoseDetector(){try{detector=await poseDetection.createDetector(poseDetection.SupportedModels.MoveNet,{modelType:poseDetection.movenet.modelType.SINGLEPOSE_THUNDER});console.log('Pose detector ready')}catch(e){console.error('Pose init failed:',e)}}

// ======================== MULTI-SWING ANALYSIS ========================
async function runAnalysis(){
    if(!videoFile||!detector){if(!detector)alert('Pose detector still loading. Wait a moment.');return}
    const overlay=document.getElementById('analyzingOverlay');overlay.classList.remove('hidden');
    updateProgress('Loading video...',5);
    try{
        // Step 1: Find all swings in the video
        updateProgress('Scanning for swings...',10);
        const swings=await detectMultipleSwings(videoFile);
        if(swings.length===0)throw new Error('No swings detected. Try a clearer video.');

        // Step 2: Analyze each swing
        detectedSwings=[];
        for(let s=0;s<swings.length;s++){
            updateProgress(`Analyzing swing ${s+1} of ${swings.length}...`,10+((s/swings.length)*80));
            const swingResult=await analyzeSwingFrames(swings[s]);
            swingResult.swingIndex=s+1;
            swingResult.status='pending'; // pending | saved | discarded
            detectedSwings.push(swingResult);
        }

        updateProgress('Done!',100);
        setTimeout(()=>{overlay.classList.add('hidden');showMultiSwingResults()},400);
    }catch(e){overlay.classList.add('hidden');alert('Analysis error: '+e.message);console.error(e)}
}

async function detectMultipleSwings(file){
    return new Promise((resolve,reject)=>{
        const video=document.createElement('video');video.muted=true;video.playsInline=true;video.preload='auto';
        video.onloadedmetadata=async()=>{
            const duration=video.duration;if(duration<0.5){reject(new Error('Video too short'));return}
            const canvas=document.getElementById('frameCanvas');const ctx=canvas.getContext('2d');
            const sampleCount=Math.min(120,Math.floor(duration*15));
            const motionProfile=[];const sampleFrames=[];

            for(let i=0;i<sampleCount;i++){
                const t=(i/sampleCount)*duration;
                try{
                    const imgData=await seekAndCapture(video,canvas,ctx,t);
                    sampleFrames.push({time:t,imageData:imgData});
                    if(i>0){const motion=computeMotion(sampleFrames[i-1].imageData,imgData,canvas.width,canvas.height);motionProfile.push({time:t,motion})}
                    else motionProfile.push({time:t,motion:0});
                }catch{motionProfile.push({time:t,motion:0})}
            }

            // Find all swing peaks
            const swingWindows=findAllSwingWindows(motionProfile,duration);
            if(swingWindows.length===0){reject(new Error('No swings detected'));return}

            // Extract 6 frames per swing
            const allSwings=[];
            for(const sw of swingWindows){
                const keyTimes=findKeyPositionTimesFromWindow(motionProfile,sw.start,sw.peak,sw.end,duration);
                const frames=[];
                for(const t of keyTimes){
                    try{const imgData=await seekAndCapture(video,canvas,ctx,t);frames.push({time:t,imageData:imgData,width:canvas.width,height:canvas.height})}
                    catch{console.warn('Frame fail at',t)}
                }
                if(frames.length>=4)allSwings.push(frames);
            }
            URL.revokeObjectURL(video.src);
            resolve(allSwings);
        };
        video.onerror=()=>reject(new Error('Could not load video'));
        video.src=URL.createObjectURL(file);
    });
}

function findAllSwingWindows(motionProfile,duration){
    const motions=motionProfile.map(m=>m.motion);
    const times=motionProfile.map(m=>m.time);
    const smoothed=smoothArray(motions,3);
    const maxMotion=Math.max(...smoothed);
    if(maxMotion<1)return[];
    const threshold=maxMotion*0.3;

    // Find all peaks above threshold
    const peaks=[];
    for(let i=2;i<smoothed.length-2;i++){
        if(smoothed[i]>threshold&&smoothed[i]>=smoothed[i-1]&&smoothed[i]>=smoothed[i+1]&&smoothed[i]>=smoothed[i-2]&&smoothed[i]>=smoothed[i+2]){
            peaks.push(i);
        }
    }

    // Merge peaks that are too close (within ~1 second)
    const minGap=Math.max(3,Math.floor(motionProfile.length/duration*0.8));
    const mergedPeaks=[];
    for(const p of peaks){
        if(mergedPeaks.length===0||p-mergedPeaks[mergedPeaks.length-1]>minGap){mergedPeaks.push(p)}
        else if(smoothed[p]>smoothed[mergedPeaks[mergedPeaks.length-1]]){mergedPeaks[mergedPeaks.length-1]=p}
    }

    // Build windows around each peak
    return mergedPeaks.map(peak=>{
        let start=peak;
        while(start>0&&smoothed[start]>threshold*0.3)start--;
        start=Math.max(0,start-3);
        let end=peak;
        while(end<smoothed.length-1&&smoothed[end]>threshold*0.3)end++;
        end=Math.min(smoothed.length-1,end+3);
        return{start,peak,end,peakTime:times[peak]};
    });
}

function findKeyPositionTimesFromWindow(motionProfile,startIdx,peakIdx,endIdx,duration){
    const times=motionProfile.map(m=>m.time);
    const smoothed=smoothArray(motionProfile.map(m=>m.motion),3);

    // Top of backswing: local min before peak
    let topIdx=Math.floor((startIdx+peakIdx)/2);
    let minVal=Infinity;
    const searchStart=Math.max(startIdx,Math.floor(startIdx+(peakIdx-startIdx)*0.25));
    for(let i=searchStart;i<peakIdx-1;i++){if(smoothed[i]<minVal){minVal=smoothed[i];topIdx=i}}

    const addressIdx=Math.max(0,startIdx);
    const takeawayIdx=addressIdx+Math.round((topIdx-addressIdx)*0.4);
    const downswingIdx=topIdx+Math.round((peakIdx-topIdx)*0.5);
    const remaining=endIdx-peakIdx;
    const followIdx=Math.min(motionProfile.length-1,peakIdx+Math.round(remaining*0.5));

    let indices=[addressIdx,takeawayIdx,topIdx,downswingIdx,peakIdx,followIdx];
    for(let i=1;i<indices.length;i++){if(indices[i]<=indices[i-1])indices[i]=Math.min(indices[i-1]+1,motionProfile.length-1)}
    return indices.map(i=>times[Math.min(i,times.length-1)]);
}

async function analyzeSwingFrames(frames){
    const positionResults=[];
    for(let i=0;i<frames.length;i++){
        const result=await analyzePosition(frames[i],POSITIONS[i]||`Position ${i+1}`);
        positionResults.push(result);
    }
    const swingScore=computeSwingScore(positionResults);
    return{positions:positionResults,swingScore,club:document.getElementById('clubSelect').value,launchData:getLaunchData(),date:new Date().toISOString()};
}

// ======================== MULTI-SWING RESULTS UI ========================
function showMultiSwingResults(){
    document.getElementById('multiSwingResults').classList.remove('hidden');
    document.getElementById('swingDetail').classList.add('hidden');
    document.getElementById('swingCountLabel').textContent=detectedSwings.length+' swing'+(detectedSwings.length!==1?'s':'');
    renderSwingList();
    speak(`Found ${detectedSwings.length} swings. Review and save the ones you want.`);
}

function renderSwingList(){
    const list=document.getElementById('swingList');
    list.innerHTML='';
    detectedSwings.forEach((sw,i)=>{
        if(sw.status==='discarded')return;
        const sc=sw.swingScore.score;
        const color=sc>=75?'var(--green)':sc>=50?'var(--yellow)':'var(--red)';
        const impactImg=sw.positions.find(p=>p.position==='Impact')?.annotatedDataUrl||sw.positions[0]?.annotatedDataUrl||'';
        const saved=sw.status==='saved';
        const div=document.createElement('div');
        div.className='swing-card';
        div.innerHTML=`
            ${impactImg?`<img src="${impactImg}" onclick="viewSwingDetail(${i})">`:''}
            <div class="swing-card-info" onclick="viewSwingDetail(${i})" style="cursor:pointer">
                <div style="font-weight:600;font-size:15px">Swing ${sw.swingIndex}</div>
                <div class="mono" style="color:${color};font-size:20px;font-weight:700">${sc}</div>
                <div style="font-size:12px;color:var(--text-dim)">HC: ${sw.swingScore.handicap}</div>
            </div>
            <div class="swing-card-actions">
                <button class="btn btn-sm ${saved?'btn-primary':'btn-ghost'}" onclick="toggleSaveSwing(${i})" style="font-size:20px;padding:8px 12px">${saved?'‚úì':'+'}</button>
                <button class="btn btn-sm btn-danger" onclick="discardSwing(${i})" style="font-size:20px;padding:8px 12px">‚úï</button>
            </div>`;
        list.appendChild(div);
    });

    const savedCount=detectedSwings.filter(s=>s.status==='saved').length;
    const batchSection=document.getElementById('batchCoachSection');
    if(savedCount>0){batchSection.classList.remove('hidden');document.getElementById('batchCoachBtn').textContent=`ü§ñ Get AI Coaching for ${savedCount} Saved Swing${savedCount!==1?'s':''}`}
    else batchSection.classList.add('hidden');
}

function toggleSaveSwing(i){detectedSwings[i].status=detectedSwings[i].status==='saved'?'pending':'saved';renderSwingList()}
function discardSwing(i){detectedSwings[i].status='discarded';renderSwingList()}
function saveAllSwings(){detectedSwings.forEach(s=>{if(s.status!=='discarded')s.status='saved'});renderSwingList()}
function discardAllSwings(){if(confirm('Discard all swings?')){detectedSwings.forEach(s=>s.status='discarded');renderSwingList()}}

function viewSwingDetail(i){
    const sw=detectedSwings[i];
    document.getElementById('swingDetail').classList.remove('hidden');
    document.getElementById('detailSwingLabel').textContent='Swing '+sw.swingIndex;

    const sc=sw.swingScore.score;
    const color=sc>=75?'var(--green)':sc>=50?'var(--yellow)':'var(--red)';
    document.getElementById('detailScoreArc').setAttribute('stroke',color);
    document.getElementById('detailScoreArc').setAttribute('stroke-dasharray',`${sc},100`);
    document.getElementById('detailScore').textContent=sc;
    document.getElementById('detailScore').style.color=color;
    document.getElementById('detailHc').textContent=sw.swingScore.handicap;
    document.getElementById('detailGrade').textContent=sw.swingScore.grade;

    const scroll=document.getElementById('detailPosScroll');scroll.innerHTML='';
    sw.positions.forEach((pos,j)=>{
        const ps=computePositionScore(pos.scores);
        const pc=ps>=75?'var(--green)':ps>=50?'var(--yellow)':'var(--red)';
        const div=document.createElement('div');
        div.className='position-thumb'+(j===0?' active':'');
        div.innerHTML=`<img src="${pos.annotatedDataUrl}" alt="${pos.position}"><div class="position-thumb-info"><div class="position-thumb-name">${pos.position}</div><div class="position-thumb-score" style="color:${pc}">${ps}</div></div>`;
        div.onclick=()=>{scroll.querySelectorAll('.position-thumb').forEach(t=>t.classList.remove('active'));div.classList.add('active');showPositionDetail(pos)};
        scroll.appendChild(div);
    });
    if(sw.positions.length>0)showPositionDetail(sw.positions[0]);
    document.getElementById('swingDetail').scrollIntoView({behavior:'smooth'});
}

function hideSwingDetail(){document.getElementById('swingDetail').classList.add('hidden')}

function showPositionDetail(pos){
    document.getElementById('detailPosDetail').classList.remove('hidden');
    document.getElementById('detailPosName').textContent=pos.position;
    const sc=computePositionScore(pos.scores);
    const el=document.getElementById('detailPosScore');el.textContent=sc+'/100';
    el.style.color=sc>=75?'var(--green)':sc>=50?'var(--yellow)':'var(--red)';
    const canvas=document.getElementById('detailCanvas');const img=new Image();
    img.onload=()=>{canvas.width=img.width;canvas.height=img.height;canvas.style.height='auto';canvas.getContext('2d').drawImage(img,0,0)};
    img.src=pos.annotatedDataUrl;

    const ad=document.getElementById('detailAngles');ad.innerHTML='';
    if(pos.scores){for(const[name,s]of Object.entries(pos.scores)){const icon=s.status==='good'?'‚úÖ':s.status==='warning'?'‚ö†Ô∏è':'üî¥';ad.innerHTML+=`<div class="angle-row"><div class="angle-name">${icon} ${formatName(name)}</div><div><span class="angle-value" style="color:${statusColor(s.status)}">${s.value}¬∞</span><span class="angle-range">(${s.range[0]}-${s.range[1]}¬∞)</span></div></div>`}}
    if(pos.angles){for(const[name,val]of Object.entries(pos.angles)){if(!pos.scores||!pos.scores[name]){if(name.startsWith('head_')||name.startsWith('hip_center'))continue;ad.innerHTML+=`<div class="angle-row"><div class="angle-name" style="color:var(--text-dim)">${formatName(name)}</div><div class="angle-value">${val}¬∞</div></div>`}}}
}

// ======================== BATCH COACHING ========================
async function runBatchCoaching(){
    const saved=detectedSwings.filter(s=>s.status==='saved');
    if(saved.length===0){alert('No saved swings. Tap + on swings you want coaching for.');return}

    const btn=document.getElementById('batchCoachBtn');btn.disabled=true;btn.textContent='ü§ñ Analyzing...';

    try{
        const coachingText=await getClaudeBatchCoaching(saved);
        // Save all swings to history
        saved.forEach(sw=>{
            const session={id:Date.now()+Math.random()*1000,date:sw.date,club:sw.club,swingScore:sw.swingScore,
                positions:sw.positions.map(p=>({position:p.position,angles:p.angles,scores:p.scores,imageData:p.annotatedDataUrl})),
                coaching:coachingText,launchData:sw.launchData,notes:''};
            appState.sessions.unshift(session);
        });
        if(appState.sessions.length>500)appState.sessions=appState.sessions.slice(0,500);
        saveState();

        const resultDiv=document.getElementById('batchCoachResult');resultDiv.classList.remove('hidden');
        const textDiv=document.getElementById('batchCoachText');
        try{textDiv.innerHTML=marked.parse(coachingText)}catch{textDiv.innerHTML=coachingText.replace(/\n/g,'<br>')}
        btn.textContent='‚úì Coaching Complete ‚Äî Swings Saved';
        speak('Coaching analysis complete. Scroll down to read.');
        resultDiv.scrollIntoView({behavior:'smooth'});
    }catch(e){btn.disabled=false;btn.textContent='ü§ñ Retry Coaching';alert('Coaching error: '+e.message)}
}

async function getClaudeBatchCoaching(swings){
    const club=swings[0].club;
    const content=[];
    let overview=`## Batch Session Analysis\n\n**Club:** ${club}\n**Swings analyzed:** ${swings.length}\n\n### Swing Scores:\n`;
    swings.forEach((sw,i)=>{overview+=`- Swing ${sw.swingIndex}: **${sw.swingScore.score}/100** (HC: ${sw.swingScore.handicap})\n`});
    content.push({type:'text',text:overview});

    // Send best, worst, and a middle swing with images
    const sorted=[...swings].sort((a,b)=>b.swingScore.score-a.swingScore.score);
    const sampled=[sorted[0]];
    if(sorted.length>1)sampled.push(sorted[sorted.length-1]);
    if(sorted.length>2)sampled.push(sorted[Math.floor(sorted.length/2)]);

    for(const sw of sampled){
        content.push({type:'text',text:`\n### Swing ${sw.swingIndex} (Score: ${sw.swingScore.score}):`});
        for(const pos of sw.positions){
            if(pos.annotatedDataUrl){
                const base64=pos.annotatedDataUrl.split(',')[1];
                content.push({type:'image',source:{type:'base64',media_type:'image/jpeg',data:base64}});
            }
            let at=`**${pos.position}:** `;
            for(const[k,v]of Object.entries(pos.angles))at+=`${k}: ${v}¬∞ `;
            content.push({type:'text',text:at});
        }
    }

    // Aggregate angle data for all swings
    let aggText='\n### All Swings ‚Äî Angle Summary:\n';
    POSITIONS.forEach(posName=>{
        aggText+=`\n**${posName}:**\n`;
        const angleNames=new Set();
        swings.forEach(sw=>{const p=sw.positions.find(x=>x.position===posName);if(p)Object.keys(p.angles).forEach(k=>angleNames.add(k))});
        angleNames.forEach(an=>{
            if(an.startsWith('head_')||an.startsWith('hip_center'))return;
            const vals=swings.map(sw=>{const p=sw.positions.find(x=>x.position===posName);return p?.angles?.[an]}).filter(v=>v!=null);
            if(vals.length>0){const avg=(vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1);const min=Math.min(...vals).toFixed(1);const max=Math.max(...vals).toFixed(1);aggText+=`- ${an}: avg ${avg}¬∞ (range: ${min}-${max}¬∞)\n`}
        });
    });
    content.push({type:'text',text:aggText});

    if(swings[0].launchData){
        let lt='\n### Launch Monitor Data:\n';
        const labels={ball_speed:'Ball Speed',club_speed:'Club Speed',launch_angle:'Launch Angle',spin_rate:'Spin Rate',carry:'Carry',smash_factor:'Smash Factor',total_distance:'Total Dist',attack_angle:'Attack Angle'};
        for(const[k,l]of Object.entries(labels)){if(swings[0].launchData[k]!=null)lt+=`- **${l}:** ${swings[0].launchData[k]}\n`}
        content.push({type:'text',text:lt});
    }

    content.push({type:'text',text:'\nProvide your complete batch session analysis. Focus on PATTERNS across swings ‚Äî what\'s consistent (good or bad), what varies, what improved or degraded. Give severity-ranked issues and top 3 priorities.'});

    const systemPrompt=`You are SwingIQ ‚Äî an expert golf coach analyzing a BATCH of ${swings.length} swings from one practice session. You have angle data from every swing plus annotated images from the best, worst, and median swings.

Your analysis should focus on PATTERNS across the session:
## üèåÔ∏è SESSION OVERVIEW
Summarize the session: consistency, best/worst swing, overall trend.

## üìä PATTERN ANALYSIS
What's consistent across swings (good and bad)? What varies most? Any fatigue pattern?

## ‚ö†Ô∏è SEVERITY-RANKED ISSUES
All issues ranked 1-10. For each: what, cause‚Üíeffect, fix, which pro does this well.

## üéØ TOP 3 PRIORITIES
Three most impactful changes with specific drills.

## üìà TRACKMAN INSIGHTS
(Only if launch data provided)

## üèÜ BEST SWING BREAKDOWN
What made the best swing work? How to replicate it.

Be specific with angles and measurements. Reference exact numbers from the data.`;

    const response=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':appState.apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
        body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:4000,system:systemPrompt,messages:[{role:'user',content}]})});
    if(!response.ok){const err=await response.json().catch(()=>({}));throw new Error(err.error?.message||`API error ${response.status}`)}
    const data=await response.json();
    return data.content.map(b=>b.text||'').join('\n');
}

// ======================== LIVE PRACTICE MODE ========================
async function initLiveCamera(){
    try{
        liveStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:1280},height:{ideal:720}},audio:false});
        document.getElementById('liveVideo').srcObject=liveStream;
    }catch(e){document.getElementById('liveStatus').textContent='Camera access denied. Check permissions.';console.error(e)}
}

function toggleLivePractice(){
    if(livePracticeActive)stopLivePractice();
    else startLivePractice();
}

function startLivePractice(){
    if(!liveStream||!detector){alert('Camera or pose detector not ready.');return}
    livePracticeActive=true;liveSwingCount=0;prevMotion=null;motionBaseline=0;
    document.getElementById('liveStartBtn').textContent='‚èπ Stop';document.getElementById('liveStartBtn').style.background='var(--red)';
    document.getElementById('liveSwingCount').classList.remove('hidden');document.getElementById('liveSwingCount').textContent='0 swings';
    document.getElementById('liveStatus').textContent='Swing when ready. Listening...';
    speak('Live practice started. Swing when ready.');

    const video=document.getElementById('liveVideo');
    const canvas=document.getElementById('liveCanvas');
    const ctx=canvas.getContext('2d');
    let prevGray=null;
    let cooldownTimer=null;

    liveAnalysisInterval=setInterval(()=>{
        if(!livePracticeActive)return;
        canvas.width=video.videoWidth||640;canvas.height=video.videoHeight||480;
        ctx.drawImage(video,0,0);
        const imgData=ctx.getImageData(0,0,canvas.width,canvas.height);

        // Simple motion detection
        const gray=toGrayscale(imgData);
        if(prevGray){
            let motion=0;const step=16;
            for(let i=0;i<gray.length;i+=step)motion+=Math.abs(gray[i]-prevGray[i]);
            motion/=(gray.length/step);

            if(motionBaseline===0)motionBaseline=motion*1.5+2;

            if(motion>motionBaseline*3&&!swingCooldown){
                // Swing detected!
                swingCooldown=true;
                setTimeout(()=>{
                    // Capture post-swing frame for analysis
                    ctx.drawImage(video,0,0);
                    const frameData=ctx.getImageData(0,0,canvas.width,canvas.height);
                    analyzeLiveSwing(frameData,canvas.width,canvas.height);
                    swingCooldown=false;
                },800); // Wait 0.8s for follow-through
            }
            // Slowly adapt baseline
            motionBaseline=motionBaseline*0.98+motion*0.02;
        }
        prevGray=gray;
    },100); // Check 10 times per second
}

function toGrayscale(imgData){const g=new Uint8Array(imgData.width*imgData.height);for(let i=0;i<g.length;i++){const j=i*4;g[i]=(imgData.data[j]*0.299+imgData.data[j+1]*0.587+imgData.data[j+2]*0.114)|0}return g}

async function analyzeLiveSwing(frameData,w,h){
    liveSwingCount++;
    document.getElementById('liveSwingCount').textContent=liveSwingCount+' swing'+(liveSwingCount!==1?'s':'');

    const canvas=document.getElementById('frameCanvas');canvas.width=w;canvas.height=h;
    canvas.getContext('2d').putImageData(frameData,0,0);

    try{
        const poses=await detector.estimatePoses(canvas);
        if(!poses.length||!poses[0].keypoints){speak('Could not detect pose. Try again.');return}

        const keypoints=poses[0].keypoints;
        const angles=calculateAngles(keypoints,w,h);
        const scores=scoreAngles(angles,'Impact'); // Score as impact position

        // Build voice feedback
        const feedback=buildVoiceFeedback(angles,scores,liveSwingCount);
        speak(feedback);

        // Show mini result card
        const annotCanvas=document.getElementById('annotCanvas');annotCanvas.width=w;annotCanvas.height=h;
        const actx=annotCanvas.getContext('2d');actx.putImageData(frameData,0,0);
        drawAnnotations(actx,keypoints,angles,scores,'Impact',w,h);
        drawHeader(actx,'Swing '+liveSwingCount,computePositionScore(scores),w);

        const resultsDiv=document.getElementById('liveResults');
        const card=document.createElement('div');card.className='swing-card fade-in';
        card.innerHTML=`<img src="${annotCanvas.toDataURL('image/jpeg',0.7)}"><div class="swing-card-info"><div style="font-weight:600">Swing ${liveSwingCount}</div><div style="font-size:12px;color:var(--text-dim)">${feedback.substring(0,60)}...</div></div>`;
        resultsDiv.insertBefore(card,resultsDiv.firstChild);

    }catch(e){console.error('Live analysis error:',e)}
}

function buildVoiceFeedback(angles,scores,count){
    let parts=[`Swing ${count}.`];

    if(scores.spine_angle){
        const s=scores.spine_angle;
        if(s.status==='good')parts.push(`Spine angle ${s.value} degrees, good.`);
        else parts.push(`Spine angle ${s.value} degrees, ${s.status==='warning'?'slightly off':'needs work'}. Aim for ${s.range[0]} to ${s.range[1]}.`);
    }

    if(scores.left_arm_angle){
        const s=scores.left_arm_angle;
        if(s.status==='good')parts.push('Left arm straight, nice.');
        else parts.push(`Left arm ${s.value} degrees. Keep it straighter through impact.`);
    }

    if(angles.knee_flex_lead!=null){
        if(angles.knee_flex_lead<135)parts.push('Knees too bent.');
        else if(angles.knee_flex_lead>165)parts.push('Legs too straight. Add some flex.');
    }

    return parts.join(' ');
}

function stopLivePractice(){
    livePracticeActive=false;
    if(liveAnalysisInterval){clearInterval(liveAnalysisInterval);liveAnalysisInterval=null}
    document.getElementById('liveStartBtn').textContent='‚ñ∂ Start';document.getElementById('liveStartBtn').style.background='';
    document.getElementById('liveStatus').textContent='Press Start to begin.';
    if(liveSwingCount>0)speak(`Session complete. ${liveSwingCount} swings analyzed.`);
}

// ======================== POSE ANALYSIS (shared) ========================
async function analyzePosition(frame,positionName){
    const canvas=document.getElementById('frameCanvas');const ctx=canvas.getContext('2d');
    canvas.width=frame.width;canvas.height=frame.height;ctx.putImageData(frame.imageData,0,0);
    let keypoints=null;
    try{const poses=await detector.estimatePoses(canvas);if(poses.length>0)keypoints=poses[0].keypoints}catch{}
    const angles=keypoints?calculateAngles(keypoints,frame.width,frame.height):{};
    const scores=scoreAngles(angles,positionName);
    const annotCanvas=document.getElementById('annotCanvas');annotCanvas.width=frame.width;annotCanvas.height=frame.height;
    const actx=annotCanvas.getContext('2d');actx.putImageData(frame.imageData,0,0);
    if(keypoints)drawAnnotations(actx,keypoints,angles,scores,positionName,frame.width,frame.height);
    drawHeader(actx,positionName,computePositionScore(scores),frame.width);
    return{position:positionName,angles,scores,positionScore:computePositionScore(scores),annotatedDataUrl:annotCanvas.toDataURL('image/jpeg',0.85),poseDetected:!!keypoints};
}

function kp(keypoints,idx){const k=keypoints[idx];return{x:k.x,y:k.y,score:k.score||0}}
function angleBetween(a,b,c){const ba={x:a.x-b.x,y:a.y-b.y};const bc={x:c.x-b.x,y:c.y-b.y};const dot=ba.x*bc.x+ba.y*bc.y;const m=Math.sqrt(ba.x*ba.x+ba.y*ba.y)*Math.sqrt(bc.x*bc.x+bc.y*bc.y);if(m===0)return 0;return Math.acos(Math.max(-1,Math.min(1,dot/m)))*(180/Math.PI)}
function angleFromVertical(a,b){return Math.atan2(Math.abs(b.x-a.x),Math.abs(b.y-a.y))*(180/Math.PI)}
function round(v){return Math.round(v*10)/10}

function calculateAngles(keypoints,w,h){
    const ls=kp(keypoints,KP.L_SHOULDER),rs=kp(keypoints,KP.R_SHOULDER),lh=kp(keypoints,KP.L_HIP),rh=kp(keypoints,KP.R_HIP);
    const lk=kp(keypoints,KP.L_KNEE),rk=kp(keypoints,KP.R_KNEE),la=kp(keypoints,KP.L_ANKLE),ra=kp(keypoints,KP.R_ANKLE);
    const le=kp(keypoints,KP.L_ELBOW),re=kp(keypoints,KP.R_ELBOW),lw=kp(keypoints,KP.L_WRIST),rw=kp(keypoints,KP.R_WRIST);
    const nose=kp(keypoints,KP.NOSE);
    const midHip={x:(lh.x+rh.x)/2,y:(lh.y+rh.y)/2};const midShoulder={x:(ls.x+rs.x)/2,y:(ls.y+rs.y)/2};
    const angles={};
    angles.spine_angle=round(angleFromVertical(midHip,midShoulder));
    angles.knee_flex_lead=round(angleBetween(lh,lk,la));
    angles.knee_flex_trail=round(angleBetween(rh,rk,ra));
    angles.left_arm_angle=round(angleBetween(ls,le,lw));
    angles.right_arm_angle=round(angleBetween(rs,re,rw));
    const sw=Math.abs(ls.x-rs.x);const hw=Math.abs(lh.x-rh.x);
    if(hw>0)angles.hip_rotation=round(Math.max(0,(1-hw/Math.max(sw,1))*90));
    angles.shoulder_tilt=round(Math.abs(Math.atan2(rs.y-ls.y,rs.x-ls.x)*(180/Math.PI)));
    angles.head_x=round(nose.x/w*100);angles.head_y=round(nose.y/h*100);angles.hip_center_x=round(midHip.x/w*100);
    return angles;
}

function scoreAngles(angles,position){
    const optimal=OPTIMAL[position]||{};const scores={};
    for(const[name,[lo,hi]]of Object.entries(optimal)){const val=angles[name];if(val==null)continue;let dev=0;if(val<lo)dev=lo-val;else if(val>hi)dev=val-hi;const score=Math.max(0,Math.round(100-dev*5));const status=dev===0?'good':dev<=5?'warning':'critical';scores[name]={score,status,value:val,range:[lo,hi],deviation:round(dev)}}
    return scores;
}

function computePositionScore(scores){const v=Object.values(scores);if(v.length===0)return 75;return Math.round(v.reduce((s,x)=>s+x.score,0)/v.length)}
function computeSwingScore(positionResults){
    let ws=0,wt=0;const ps={};
    for(const r of positionResults){const s=r.positionScore;ps[r.position]=s;const w=POS_WEIGHTS[r.position]||1;ws+=s*w;wt+=w}
    const score=wt>0?Math.round(ws/wt):0;
    let hc;if(score>=90)hc=Math.max(-2,(100-score)*.5-2);else if(score>=80)hc=(90-score)*.5;else if(score>=70)hc=5+(80-score)*.5;else if(score>=60)hc=10+(70-score)*.5;else if(score>=50)hc=15+(60-score)*.5;else if(score>=40)hc=20+(50-score)*.5;else hc=25+(40-score)*.5;
    let grade;if(score>=90)grade='Tour-caliber';else if(score>=80)grade='Very strong fundamentals';else if(score>=70)grade='Solid, minor issues';else if(score>=60)grade='Good foundation';else if(score>=50)grade='Developing swing';else if(score>=40)grade='Fundamentals need work';else grade='Needs rebuilding';
    return{score,handicap:Math.round(hc*10)/10,grade,positionScores:ps};
}

// ======================== DRAWING ========================
function drawAnnotations(ctx,keypoints,angles,scores,position,w,h){
    const ls=kp(keypoints,KP.L_SHOULDER),rs=kp(keypoints,KP.R_SHOULDER),lh=kp(keypoints,KP.L_HIP),rh=kp(keypoints,KP.R_HIP);
    const lk=kp(keypoints,KP.L_KNEE),rk=kp(keypoints,KP.R_KNEE),la=kp(keypoints,KP.L_ANKLE),ra=kp(keypoints,KP.R_ANKLE);
    const le=kp(keypoints,KP.L_ELBOW),re=kp(keypoints,KP.R_ELBOW),lw=kp(keypoints,KP.L_WRIST),rw=kp(keypoints,KP.R_WRIST);
    const nose=kp(keypoints,KP.NOSE);
    const midHip={x:(lh.x+rh.x)/2,y:(lh.y+rh.y)/2};const midShoulder={x:(ls.x+rs.x)/2,y:(ls.y+rs.y)/2};
    const lw2=Math.max(2,w/300);const dotR=Math.max(4,w/150);

    // Skeleton
    const pairs=[[ls,rs],[lh,rh],[ls,lh],[rs,rh],[ls,le],[le,lw],[rs,re],[re,rw],[lh,lk],[lk,la],[rh,rk],[rk,ra],[ls,nose],[rs,nose]];
    ctx.strokeStyle='rgba(200,200,200,0.4)';ctx.lineWidth=Math.max(1.5,w/400);
    for(const[a,b]of pairs){ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(b.x,b.y);ctx.stroke()}

    // Joints
    const joints=[ls,rs,lh,rh,lk,rk,la,ra,le,re,lw,rw,nose];
    for(const j of joints){ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(j.x,j.y,dotR,0,Math.PI*2);ctx.fill();ctx.strokeStyle='rgba(52,211,153,0.8)';ctx.lineWidth=1.5;ctx.stroke()}

    // Spine line
    const sc=scores.spine_angle?.status||'good';ctx.strokeStyle=statusColor(sc);ctx.lineWidth=Math.max(3,w/200);
    const dx=midShoulder.x-midHip.x,dy=midShoulder.y-midHip.y;
    ctx.beginPath();ctx.moveTo(midHip.x-dx*.25,midHip.y-dy*.25);ctx.lineTo(midShoulder.x+dx*.3,midShoulder.y+dy*.3);ctx.stroke();

    // Vertical reference
    ctx.strokeStyle='rgba(100,100,100,0.4)';ctx.lineWidth=1;ctx.setLineDash([4,4]);
    ctx.beginPath();ctx.moveTo(midHip.x,midHip.y);ctx.lineTo(midHip.x,midHip.y-Math.abs(dy)*1.3);ctx.stroke();ctx.setLineDash([]);

    // Swing plane line (from hands through ball area)
    if(position==='Downswing'||position==='Impact'){
        ctx.strokeStyle='rgba(52,211,153,0.5)';ctx.lineWidth=Math.max(2,w/300);ctx.setLineDash([6,4]);
        const handMid={x:(lw.x+rw.x)/2,y:(lw.y+rw.y)/2};
        const extX=handMid.x+(handMid.x-midShoulder.x)*2;const extY=handMid.y+(handMid.y-midShoulder.y)*2;
        ctx.beginPath();ctx.moveTo(midShoulder.x,midShoulder.y);ctx.lineTo(extX,extY);ctx.stroke();ctx.setLineDash([]);
    }

    // Labels
    if(angles.spine_angle!=null)drawLabel(ctx,`Spine: ${angles.spine_angle}¬∞`,midHip.x+15,midHip.y-25,statusColor(sc),w);
    const armSc=scores.left_arm_angle?.status||'good';ctx.strokeStyle=statusColor(armSc);ctx.lineWidth=Math.max(2.5,w/250);
    ctx.beginPath();ctx.moveTo(ls.x,ls.y);ctx.lineTo(le.x,le.y);ctx.lineTo(lw.x,lw.y);ctx.stroke();
    if(angles.left_arm_angle!=null)drawLabel(ctx,`L Arm: ${angles.left_arm_angle}¬∞`,le.x-70,le.y-10,statusColor(armSc),w);
    if(angles.knee_flex_lead!=null){const ks=scores.knee_flex_lead?.status||'good';drawLabel(ctx,`Knee: ${angles.knee_flex_lead}¬∞`,lk.x-60,lk.y+15,statusColor(ks),w)}
    if(angles.hip_rotation!=null)drawLabel(ctx,`Hip Rot: ${angles.hip_rotation}¬∞`,midHip.x-80,midHip.y+20,'#60a5fa',w);
    if(angles.shoulder_tilt!=null&&(position==='Top'||position==='Impact'))drawLabel(ctx,`Shoulder: ${angles.shoulder_tilt}¬∞`,midShoulder.x-60,midShoulder.y-25,'#c084fc',w);
}

function drawHeader(ctx,position,score,w){const h=Math.max(36,w/12);ctx.fillStyle='rgba(0,0,0,0.7)';ctx.fillRect(0,0,w,h);ctx.font=`bold ${h*.5}px 'DM Sans',sans-serif`;ctx.fillStyle='#fff';ctx.fillText(position,10,h*.68);const color=score>=75?'#34d399':score>=50?'#fbbf24':'#f87171';const t=`${score}/100`;const tm=ctx.measureText(t);ctx.fillStyle=color;ctx.fillText(t,w-tm.width-10,h*.68)}
function drawLabel(ctx,text,x,y,color,fw){const fs=Math.max(11,fw/50);ctx.font=`500 ${fs}px 'DM Sans',sans-serif`;const tm=ctx.measureText(text);x=Math.max(5,Math.min(x,fw-tm.width-13));ctx.fillStyle='rgba(0,0,0,0.75)';ctx.fillRect(x-4,y-fs-3,tm.width+8,fs+8);ctx.fillStyle=color;ctx.fillText(text,x,y)}
function statusColor(s){return s==='good'?'#34d399':s==='warning'?'#fbbf24':'#f87171'}
function formatName(n){return n.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase())}

// ======================== HELPERS ========================
function seekAndCapture(video,canvas,ctx,time){return new Promise((resolve,reject)=>{video.currentTime=time;video.onseeked=()=>{canvas.width=video.videoWidth;canvas.height=video.videoHeight;ctx.drawImage(video,0,0);resolve(ctx.getImageData(0,0,canvas.width,canvas.height))};video.onerror=reject;setTimeout(()=>reject(new Error('Seek timeout')),5000)})}
function computeMotion(prev,curr,w,h){let d=0;const step=8;for(let i=0;i<prev.data.length;i+=step*4){d+=(Math.abs(prev.data[i]-curr.data[i])+Math.abs(prev.data[i+1]-curr.data[i+1])+Math.abs(prev.data[i+2]-curr.data[i+2]))/3}return d/(prev.data.length/(step*4))}
function smoothArray(arr,r){const res=[];for(let i=0;i<arr.length;i++){let s=0,c=0;for(let j=Math.max(0,i-r);j<=Math.min(arr.length-1,i+r);j++){s+=arr[j];c++}res.push(s/c)}return res}
function getLaunchData(){const f={ball_speed:'lmBallSpeed',club_speed:'lmClubSpeed',launch_angle:'lmLaunch',spin_rate:'lmSpin',carry:'lmCarry',smash_factor:'lmSmash',total_distance:'lmTotal',attack_angle:'lmAttack'};const d={};for(const[k,id]of Object.entries(f)){const v=document.getElementById(id).value;if(v)d[k]=parseFloat(v)}return Object.keys(d).length>0?d:null}
function updateProgress(step,pct){document.getElementById('analysisStep').textContent=step;document.getElementById('progressFill').style.width=pct+'%'}

// ======================== HISTORY ========================
function renderHistory(){
    const filter=document.getElementById('histFilter').value;let sessions=appState.sessions;if(filter)sessions=sessions.filter(s=>s.club===filter);
    const list=document.getElementById('histList');
    if(sessions.length===0){list.innerHTML='<p style="text-align:center;color:var(--text-dim);padding:40px 0">No sessions yet.</p>';return}
    list.innerHTML=sessions.map(s=>{
        const date=new Date(s.date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
        const sc=s.swingScore?.score??'--';const hc=s.swingScore?.handicap??'--';
        const color=sc>=75?'var(--green)':sc>=50?'var(--yellow)':'var(--red)';
        return`<div class="card history-item"><div><div style="font-weight:600;font-size:15px">${s.club}</div><div style="font-size:12px;color:var(--text-dim)">${date}</div></div><div style="text-align:right"><div class="mono" style="color:${color};font-size:20px;font-weight:700">${sc}</div><div style="font-size:12px;color:var(--text-dim)">HC: ${hc}</div></div></div>`
    }).join('');
}

// ======================== PROGRESS CHARTS ========================
let chartScore,chartHc,chartLm;
function renderProgress(){
    const filter=document.getElementById('progFilter').value;let sessions=[...appState.sessions].reverse();if(filter)sessions=sessions.filter(s=>s.club===filter);
    if(sessions.length===0)return;
    const labels=sessions.map(s=>new Date(s.date).toLocaleDateString('en-US',{month:'short',day:'numeric'}));
    const co={responsive:true,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#6b7280',font:{size:10}},grid:{color:'rgba(255,255,255,0.05)'}},y:{ticks:{color:'#6b7280'},grid:{color:'rgba(255,255,255,0.05)'}}}};
    if(chartScore)chartScore.destroy();chartScore=new Chart(document.getElementById('progScoreChart'),{type:'line',data:{labels,datasets:[{data:sessions.map(s=>s.swingScore?.score),borderColor:'#34d399',backgroundColor:'rgba(52,211,153,.08)',fill:true,tension:.3,pointRadius:4}]},options:{...co,scales:{...co.scales,y:{...co.scales.y,min:0,max:100}}}});
    if(chartHc)chartHc.destroy();chartHc=new Chart(document.getElementById('progHcChart'),{type:'line',data:{labels,datasets:[{data:sessions.map(s=>s.swingScore?.handicap),borderColor:'#fbbf24',backgroundColor:'rgba(251,191,36,.08)',fill:true,tension:.3,pointRadius:4}]},options:co});
    if(chartLm)chartLm.destroy();const colors={ball_speed:'#f87171',club_speed:'#60a5fa',carry:'#34d399',smash_factor:'#a78bfa'};const dl={ball_speed:'Ball Speed',club_speed:'Club Speed',carry:'Carry',smash_factor:'Smash√ó100'};const ds=[];
    for(const[k,c]of Object.entries(colors)){const vals=sessions.map(s=>{const v=s.launchData?.[k];return v!=null?(k==='smash_factor'?v*100:v):null});if(vals.some(v=>v!=null))ds.push({label:dl[k],data:vals,borderColor:c,tension:.3,pointRadius:3,spanGaps:true})}
    chartLm=new Chart(document.getElementById('progLmChart'),{type:'line',data:{labels,datasets:ds},options:{...co,plugins:{legend:{display:true,labels:{color:'#6b7280',font:{size:10}}}}}});
}

// ======================== INIT ========================
initApp();
</script>
</body>
</html>
